"use strict";var FOUR=FOUR||{};FOUR.BoundingBox=function(){function BoundingBox(name){THREE.Object3D.call(this),this.depth=0,this.envelope=null,this.height=0,this.name=name,this.width=0,this.visible=!1,this.reset()}return BoundingBox.prototype=Object.create(THREE.Object3D.prototype),BoundingBox.prototype.constructor=BoundingBox,BoundingBox.prototype.getCenter=function(){return this.position},BoundingBox.prototype.getEnvelope=function(){return this.envelope},BoundingBox.prototype.getRadius=function(){return this.helper.geometry.boundingSphere.radius},BoundingBox.prototype.getXDimension=function(){return this.width},BoundingBox.prototype.getYDimension=function(){return this.depth},BoundingBox.prototype.getZDimension=function(){return this.height},BoundingBox.prototype.reset=function(){var self=this;self.position.set(0,0,0),self.envelope=new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0)),self.children.forEach(function(obj){self.remove(obj)});var geom=new THREE.BoxGeometry(1,1,1),mesh=new THREE.Mesh(geom);self.helper=new THREE.BoxHelper(mesh)},BoundingBox.prototype.toggleVisibility=function(){var self=this;self.visible=!self.visible},BoundingBox.prototype.update=function(objects){console.log("bounding box update");var self=this;if(self.reset(),objects&&objects.length>0){self.envelope.setFromObject(objects[0]),objects.forEach(function(obj){var objEnv=new THREE.Box3(new THREE.Vector3(0,0,0),new THREE.Vector3(0,0,0));objEnv.setFromObject(obj),self.envelope.union(objEnv)}),self.width=self.envelope.max.x-self.envelope.min.x,self.depth=self.envelope.max.y-self.envelope.min.y,self.height=self.envelope.max.z-self.envelope.min.z;var geom=new THREE.BoxGeometry(self.width,self.depth,self.height),mesh=new THREE.Mesh(geom);self.helper=new THREE.BoxHelper(mesh),self.add(self.helper)}else self.visible=!1;self.position.set(self.envelope.min.x+self.width/2,self.envelope.min.y+self.depth/2,self.envelope.min.z+self.height/2)},BoundingBox}();var FOUR=FOUR||{};FOUR.KeyStateController=function(){function KeyStateController(config){THREE.EventDispatcher.call(this),config=config||{};var self=this;self.KEYS={ALT:"alt",CTRL:"ctrl",CTRL_A:"ctrl+a",CTRL_N:"ctrl+n",DOWN:"down",LEFT:"left",META:"meta",RIGHT:"right",SHIFT:"shift",UP:"up"},self.enabled=config.enabled||!1,self.modifiers={},Object.keys(self.KEYS).forEach(function(key){self.modifiers[self.KEYS[key]]=!1}),Mousetrap.bind("alt",function(evt){self.keydown(self.KEYS.ALT,evt)},"keydown"),Mousetrap.bind("alt",function(evt){self.keyup(self.KEYS.ALT,evt)},"keyup"),Mousetrap.bind("ctrl",function(evt){self.keydown(self.KEYS.CTRL,evt)},"keydown"),Mousetrap.bind("ctrl",function(evt){self.keyup(self.KEYS.CTRL,evt)},"keyup"),Mousetrap.bind("shift",function(evt){self.keydown(self.KEYS.SHIFT,evt)},"keydown"),Mousetrap.bind("shift",function(evt){self.keyup(self.KEYS.SHIFT,evt)},"keyup"),Mousetrap.bind("ctrl+a",function(evt){self.keyup(self.KEYS.CTRL_A,evt)}),Mousetrap.bind("ctrl+n",function(evt){self.keyup(self.KEYS.CTRL_N,evt)}),Mousetrap.bind("i",function(evt){self.keydown(self.KEYS.UP,evt)},"keydown"),Mousetrap.bind("i",function(evt){self.keyup(self.KEYS.UP,evt)},"keyup"),Mousetrap.bind("k",function(evt){self.keydown(self.KEYS.DOWN,evt)},"keydown"),Mousetrap.bind("k",function(evt){self.keyup(self.KEYS.DOWN,evt)},"keyup"),Mousetrap.bind("j",function(evt){self.keydown(self.KEYS.LEFT,evt)},"keydown"),Mousetrap.bind("j",function(evt){self.keyup(self.KEYS.LEFT,evt)},"keyup"),Mousetrap.bind("l",function(evt){self.keydown(self.KEYS.RIGHT,evt)},"keydown"),Mousetrap.bind("l",function(evt){self.keyup(self.KEYS.RIGHT,evt)},"keyup"),Mousetrap.bind("u",function(evt){self.keydown(self.KEYS.RIGHT,evt)},"keydown"),Mousetrap.bind("u",function(evt){self.keyup(self.KEYS.RIGHT,evt)},"keyup"),Mousetrap.bind("o",function(evt){self.keydown(self.KEYS.RIGHT,evt)},"keydown"),Mousetrap.bind("o",function(evt){self.keyup(self.KEYS.RIGHT,evt)},"keyup")}return KeyStateController.prototype=Object.create(THREE.EventDispatcher.prototype),KeyStateController.prototype.constructor=KeyStateController,KeyStateController.prototype.keydown=function(key,evt){this.modifiers[key]=!0,this.dispatchEvent({type:"keydown",key:key,keyCode:evt?evt.keyCode:null})},KeyStateController.prototype.keyup=function(key,evt){this.modifiers[key]=!1,this.dispatchEvent({type:"keyup",key:key,keyCode:evt?evt.keyCode:null})},KeyStateController.prototype.register=function(command,callback){throw new Error("not implemented")},KeyStateController}();var FOUR=FOUR||{};FOUR.PathPlanner=function(){function distance(p1,p2){var dx=Math.pow(p2.x+p1.x,2),dy=Math.pow(p2.y+p1.y,2),dz=Math.pow(p2.z+p1.z,2);return Math.sqrt(dx+dy+dz)}function PathPlanner(){}return PathPlanner.prototype.generateWalkPath=function(){var material,geometry,i,line,self=this,ts=new TravellingSalesman(50),selected=self.selection.getObjects();selected.length>0?selected.forEach(function(obj){ts.addPoint({focus:0,obj:obj,radius:obj.geometry.boundingSphere.radius,x:obj.position.x,y:obj.position.y,z:obj.position.z})}):self.scene.traverse(function(obj){ts.addPoint({focus:0,obj:obj,radius:obj.geometry.boundingSphere.radius,x:obj.position.x,y:obj.position.y,z:obj.position.z})}),ts.init(),console.log("Initial distance: "+ts.getPopulation().getFittest().getDistance()),ts.evolve(100),console.log("Final distance: "+ts.getPopulation().getFittest().getDistance()),console.log(ts.getPopulation().getFittest()),self.walk.path=ts.getSolution();var lastpoint=self.walk.path[0];for(i=1;i<self.walk.path.length;i++){var point=self.walk.path[i];material=new THREE.LineBasicMaterial({color:204}),geometry=new THREE.Geometry,geometry.vertices.push(new THREE.Vector3(lastpoint.x,lastpoint.y,lastpoint.z),new THREE.Vector3(point.x,point.y,point.z)),line=new THREE.Line(geometry,material),self.scene.add(line),lastpoint=point}self.walk.index=0},PathPlanner.prototype.moveToNextWaypointFeature=function(){console.log("move to next bounding box focal point");var z,self=this,waypoint=self.walk.path[self.walk.index],obj=waypoint.obj;"pole"===obj.userData.type?(console.log("pole"),0===waypoint.focus?(z=obj.geometry.boundingSphere.radius,waypoint.focus=1):1===waypoint.focus?(z=-(2*obj.geometry.boundingSphere.radius),waypoint.focus=2):2===waypoint.focus&&(z=obj.geometry.boundingSphere.radius,waypoint.focus=0),self.tweenCameraToPosition(self.camera.position.x,self.camera.position.y,self.camera.position.z+z,obj.position.x,obj.position.y,obj.position.z+z)):"catenary"===obj.userData.type&&console.log("catenary")},PathPlanner.prototype.tweenToPosition=function(camera,position,target,progress){return new Promise(function(resolve){var emit=progress,start={x:camera.position.x,y:camera.position.y,z:camera.position.z,tx:camera.target.x,ty:camera.target.y,tz:camera.target.z},finish={x:position.x,y:position.y,z:position.z,tx:target.x,ty:target.y,tz:target.z},tween=new TWEEN.Tween(start).to(finish,1500);tween.easing(TWEEN.Easing.Cubic.InOut),tween.onComplete(function(){emit("continuous-update-end"),resolve()}),tween.onUpdate(function(){var tweened=this;camera.distance=distance(camera.position,camera.target),camera.lookAt(new THREE.Vector3(tweened.tx,tweened.ty,tweened.tz)),camera.position.set(tweened.x,tweened.y,tweened.z),camera.target.set(tweened.tx,tweened.ty,tweened.tz),emit("update")}),tween.start(),emit("continuous-update-start"),emit("update")})},PathPlanner.prototype.walkToNextPoint=function(){console.log("walk to next point");var self=this;self.walk.index>=self.walk.path.length-1?self.walk.index=0:self.walk.index+=1;var point=self.walk.path[self.walk.index],offset=0,dist=10/Math.tan(Math.PI*self.camera.fov/360),target=new THREE.Vector3(0,0,-(dist+offset));target.applyQuaternion(self.camera.quaternion),target.add(self.camera.position);var diff=(new THREE.Vector3).subVectors(new THREE.Vector3(point.x,point.y,point.z),target),next=(new THREE.Vector3).add(self.camera.position,diff);self.tweenCameraToPosition(next.x,next.y,next.z,point.x,point.y,2)},PathPlanner.prototype.walkToPreviousPoint=function(){console.log("walk to previous point");var self=this;self.walk.index<=0?self.walk.index=self.walk.path.length-1:self.walk.index-=1;var point=self.walk.path[self.walk.index],offset=0,dist=10/Math.tan(Math.PI*self.camera.fov/360),target=new THREE.Vector3(0,0,-(dist+offset));target.applyQuaternion(self.camera.quaternion),target.add(self.camera.position);var diff=(new THREE.Vector3).subVectors(new THREE.Vector3(point.x,point.y,point.z),target),next=(new THREE.Vector3).add(self.camera.position,diff);self.tweenCameraToPosition(next.x,next.y,next.z,point.x,point.y,2)},PathPlanner}();var FOUR=FOUR||{};FOUR.Scene3D=function(){function Scene3D(){THREE.Scene.call(this);var self=this;self.boundingBox=new FOUR.BoundingBox("scene-bounding-box"),self.cameras=new THREE.Object3D,self.helpers=new THREE.Object3D,self.lights=new THREE.Object3D,self.model=new THREE.Object3D,self.selection=new FOUR.SelectionSet({scene:self}),self.add(self.cameras),self.add(self.lights),self.add(self.model),self.add(self.helpers),self.helpers.add(self.boundingBox),self.selection.addEventListener("update",function(){self.boundingBox.update(self.selection.getObjects())}),self.selection.addEventListener("update",function(){})}var camera={far:1e3,fov:45,height:1,near:.1,width:1};return Scene3D.prototype=Object.create(THREE.Scene.prototype),Scene3D.prototype.DEFAULT_CAMERA_NAME="camera1",Scene3D.prototype.constructor=Scene3D,Scene3D.prototype.createDefaultCamera=function(config){var self=this;Object.keys(config).forEach(function(key){camera[key]=config[key]});var targetcamera=new FOUR.TargetCamera(camera.fov,camera.width/camera.height,camera.near,camera.far);targetcamera.name=self.DEFAULT_CAMERA_NAME,self.cameras.add(targetcamera),targetcamera.setPositionAndTarget(-50,-50,50,0,0,0),targetcamera.addEventListener("continuous-update-end",function(){self.emit("continuous-update-end")}),targetcamera.addEventListener("continuous-update-start",function(){self.emit("continuous-update-start")}),targetcamera.addEventListener("update",function(){self.emit("update")})},Scene3D.prototype.emit=function(type){this.dispatchEvent({type:type})},Scene3D.prototype.getCamera=function(name){var self=this;return self.getCameras(function(obj){return obj.name===name}).pop()},Scene3D.prototype.getCameras=function(filter){var cameras=[],self=this;return filter||(filter=filter||function(){return!0}),self.cameras.traverse(function(obj){filter(obj)&&cameras.push(obj)}),cameras},Scene3D.prototype.getLight=function(name){throw new Error("not implemented")},Scene3D.prototype.getLights=function(){throw new Error("not implemented")},Scene3D.prototype.load=function(){throw new Error("not implemented")},Scene3D}();var FOUR=FOUR||{};FOUR.SelectionControl=function(){function SelectionControl(config){THREE.EventDispatcher.call(this),config=config||{};var self=this;self.KEY={SHIFT:16,CTRL:17,ALT:18},self.MODE={POINT:0,FACE:1,MESH:2,OBJECT:3},self.MODIFIERS={ALT:"alt",CTRL:"ctrl",META:"meta",SHIFT:"shift"},self.enabled=config.enabled||!1,self.modifiers={},self.mouse=new THREE.Vector2,self.raycaster=new THREE.Raycaster,self.selection=config.viewport.scene.selection,self.viewport=config.viewport,Object.keys(self.MODIFIERS).forEach(function(key){self.modifiers[self.MODIFIERS[key]]=!1}),self.selection.addEventListener("update",self.update.bind(self),!1),self.viewport.domElement.addEventListener("contextmenu",self.onContextMenu.bind(self),!1),self.viewport.domElement.addEventListener("mousedown",self.onMouseDown.bind(self),!1),self.viewport.domElement.addEventListener("mousemove",self.onMouseMove.bind(self),!1),self.viewport.domElement.addEventListener("mouseover",self.onMouseOver.bind(self),!1),self.viewport.domElement.addEventListener("mouseup",self.onMouseUp.bind(self),!1)}return SelectionControl.prototype=Object.create(THREE.EventDispatcher.prototype),SelectionControl.prototype.constructor=SelectionControl,SelectionControl.prototype.count=function(){return this.selection.getObjects().length},SelectionControl.prototype.disable=function(){this.enabled=!1},SelectionControl.prototype.enable=function(){this.enabled=!0},SelectionControl.prototype.onContextMenu=function(event){event.preventDefault(),event.stopPropagation()},SelectionControl.prototype.onKeyDown=function(event){var self=this;(event.keyCode===self.KEY.ALT||event.keyCode===self.KEY.CTRL||event.keyCode===self.KEY.SHIFT)&&(this.modifiers[event.keyCode]=!0)},SelectionControl.prototype.onKeyUp=function(event){var self=this;event.keyCode===self.KEY.ALT||event.keyCode===self.KEY.CTRL||event.keyCode===self.KEY.SHIFT?this.modifiers[event.keyCode]=!1:"ctrl+a"===event.key?this.selectAll():"ctrl+n"===event.key&&this.selectNone()},SelectionControl.prototype.onMouseDown=function(event){},SelectionControl.prototype.onMouseMove=function(event){},SelectionControl.prototype.onMouseOver=function(event){},SelectionControl.prototype.onMouseUp=function(event){event.preventDefault(),event.stopPropagation();var self=this;if(self.enabled){self.mouse.x=event.offsetX/self.viewport.domElement.clientWidth*2-1,self.mouse.y=2*-(event.offsetY/self.viewport.domElement.clientHeight)+1,self.raycaster.setFromCamera(self.mouse,self.viewport.camera);var intersects=self.raycaster.intersectObjects(self.viewport.scene.model.children,!0)||[],objs=intersects&&intersects.length>0?[intersects[0].object]:[];self.modifiers[self.KEY.SHIFT]===!0?self.selection.addAll(objs):self.modifiers[self.KEY.ALT]===!0?self.selection.removeAll(objs):self.selection.toggle(objs)}},SelectionControl.prototype.selectAll=function(){console.log("select all"),this.selection.addAll(this.viewport.scene.model.children)},SelectionControl.prototype.selectByFilter=function(filter){console.log("select by filter");var objs=[],self=this;self.viewport.scene.traverse(function(obj){filter(obj)&&objs.push(obj)}),self.selection.addAll(objs)},SelectionControl.prototype.selectByMarquee=function(event){throw console.log("select by marquee"),new Error("not implemented")},SelectionControl.prototype.selectNone=function(){console.log("select none"),this.selection.removeAll()},SelectionControl.prototype.update=function(){this.dispatchEvent({type:"update"})},SelectionControl}();var FOUR=FOUR||{};FOUR.SelectionSet=function(){function SelectionSet(config){THREE.EventDispatcher.call(this);var self=this;config=config||{},self.count=0,self.name="selection-set",self.selectedColor=16734720,self.scene={},self.selection={},Object.keys(config).forEach(function(key){self[key]=config[key]})}return SelectionSet.prototype=Object.create(THREE.EventDispatcher.prototype),SelectionSet.prototype.constructor=SelectionSet,SelectionSet.prototype.add=function(obj,filter,update){var self=this;filter=filter||self.defaultFilter,filter(obj)&&(self.selection[obj.uuid]=obj,self.select(obj)),self.count=Object.keys(self.selection).length,update&&update===!0&&self.dispatchEvent({type:"update"})},SelectionSet.prototype.addAll=function(objects){if(!(objects.length<1)){var self=this;objects.forEach(function(obj){self.add(obj,null,!1)}),self.dispatchEvent({type:"update"})}},SelectionSet.prototype.defaultFilter=function(){return!0},SelectionSet.prototype.deselect=function(obj){obj.userData.hasOwnProperty("color")&&(obj.material.color.set(obj.userData.color),obj.userData.color=null)},SelectionSet.prototype.getBoundingBox=function(){var self=this,objs=self.getObjects(),bbox=new FOUR.BoundingBox;return bbox.name=self.name+"-bounding-box",bbox.update(objs),bbox},SelectionSet.prototype.getObjects=function(){var objects=[],self=this;return Object.keys(self.selection).forEach(function(key){objects.push(self.selection[key])}),objects},SelectionSet.prototype.remove=function(obj,update){var self=this;self.deselect(obj),delete self.selection[obj.uuid],self.count=Object.keys(self.selection).length,update&&update===!0&&self.dispatchEvent({type:"update"})},SelectionSet.prototype.removeAll=function(objects){var self=this;if(objects){if(!(objects.length>0))return;objects.forEach(function(obj){self.remove(obj,!1)})}else Object.keys(self.selection).forEach(function(uuid){self.remove(self.selection[uuid],!1)});self.dispatchEvent({type:"update"})},SelectionSet.prototype.select=function(obj){var self=this;obj.material&&obj.material.color&&(obj.userData.color=new THREE.Color(obj.material.color.r,obj.material.color.g,obj.material.color.b),obj.material.color.set(self.selectedColor))},SelectionSet.prototype.toggle=function(objects){var self=this,selected=objects.reduce(function(map,obj){return map[obj.uuid]=obj,map},{});if(Object.keys(selected).length>0)Object.keys(self.selection).forEach(function(uuid){selected[uuid]||self.remove(self.selection[uuid],!1)}),Object.keys(selected).forEach(function(uuid){self.selection[uuid]?self.remove(self.selection[uuid],!1):self.add(selected[uuid],null,!1)});else{var objs=Object.keys(self.selection).reduce(function(list,uuid){return list.push(self.selection[uuid]),list},[]);self.removeAll(objs)}self.dispatchEvent({type:"update"})},SelectionSet}();var FOUR=FOUR||{};FOUR.TargetCamera=function(){var TargetCamera=function(fov,aspect,near,far){THREE.PerspectiveCamera.call(this);var geometry,material,self=this;self.VIEWS={TOP:0,LEFT:1,RIGHT:2,FRONT:3,BACK:4,PERSPECTIVE:5},self.ZOOM_FACTOR=1.5,self.aspect=aspect,self.far=far,self.fov=fov,self.near=near,self.up=new THREE.Vector3(0,0,1),self.updateProjectionMatrix(),self.distance=100,self.target=new THREE.Vector3(0,0,self.distance),self.planner=new FOUR.PathPlanner,self.frustrum=new THREE.CameraHelper(self),self.frustrum.visible=!1,self.add(self.frustrum),geometry=new THREE.BoxGeometry(1,1,1),material=new THREE.MeshBasicMaterial({color:255}),self.targetHelper=new THREE.Mesh(geometry,material),self.targetHelper.position.set(0,0,-100),self.targetHelper.name="target",self.targetHelper.visible=!1,self.add(self.targetHelper),self.lookAt(self.target),self.distance=self.getDistance(self.position,self.target)};return TargetCamera.prototype=Object.create(THREE.PerspectiveCamera.prototype),TargetCamera.prototype.constructor=TargetCamera,TargetCamera.prototype.emit=function(event){this.dispatchEvent({type:event})},TargetCamera.prototype.getDistance=function(){return this.distance},TargetCamera.prototype.getTarget=function(){return this.target},TargetCamera.prototype.handleResize=function(){throw new Error("not implemented")},TargetCamera.prototype.hideFrustrum=function(){this.frustrum.visible=!1,this.emit("update")},TargetCamera.prototype.hideTarget=function(){this.targetHelper.visible=!1,this.emit("update")},TargetCamera.prototype.setDistance=function(dist){console.log("update the camera distance from target");var offset,distance,next,self=this;return offset=(new THREE.Vector3).subVectors(self.position,self.target),distance=offset.length(),offset.setLength(dist),next=(new THREE.Vector3).addVectors(self.target,offset),self.planner.tweenToPosition(self,new THREE.Vector3(next.x,next.y,next.z),self.target,self.emit.bind(self))},TargetCamera.prototype.setPosition=function(x,y,z){var self=this;return self.planner.tweenToPosition(self,new THREE.Vector3(x,y,z),self.target,self.emit.bind(self))},TargetCamera.prototype.setPositionAndTarget=function(x,y,z,tx,ty,tz){var self=this;return self.planner.tweenToPosition(self,new THREE.Vector3(x,y,z),new THREE.Vector3(tx,ty,tz),self.emit.bind(self))},TargetCamera.prototype.setTarget=function(x,y,z){var self=this;return self.planner.tweenToPosition(self,self.position,new THREE.Vector3(x,y,z),self.emit.bind(self))},TargetCamera.prototype.setView=function(view,bbox){var dist,height,offset,self=this,center=bbox.getCenter(),cx=center.x,cy=center.y,cz=center.z,tx=center.x,ty=center.y,tz=center.z;view===self.VIEWS.TOP?(height=bbox.getYDimension(),offset=bbox.getZDimension()/2,dist=height/2/Math.tan(Math.PI*self.fov/360),cz=center.z+dist+offset):view===self.VIEWS.FRONT?(height=bbox.getZDimension(),offset=bbox.getYDimension()/2,dist=height/2/Math.tan(Math.PI*self.fov/360),cy=center.y-dist-offset):view===self.VIEWS.BACK?(height=bbox.getZDimension(),offset=bbox.getYDimension()/2,dist=height/2/Math.tan(Math.PI*self.fov/360),cy=center.y+dist+offset):view===self.VIEWS.RIGHT?(height=bbox.getZDimension(),offset=bbox.getXDimension()/2,dist=height/2/Math.tan(Math.PI*self.fov/360),cx=center.x+dist+offset):view===self.VIEWS.LEFT?(height=bbox.getZDimension(),offset=bbox.getXDimension()/2,dist=height/2/Math.tan(Math.PI*self.fov/360),cx=center.x-dist-offset):view===self.VIEWS.PERSPECTIVE&&(cx=center.x-50,cy=center.y-50,cz=center.z+50,tx=center.x,ty=center.y,tz=center.z),self.planner.tweenToPosition(self,new THREE.Vector3(cx,cy,cz),new THREE.Vector3(tx,ty,tz),self.emit.bind(self))},TargetCamera.prototype.showFrustrum=function(){var self=this;self.frustrum.visible=!0,this.emit("update")},TargetCamera.prototype.showTarget=function(){this.targetHelper.visible=!0,this.emit("update")},TargetCamera.prototype.translate=function(x,y,z){var self=this;self.position.add(new THREE.Vector3(x,y,z)),self.target.add(new THREE.Vector3(x,y,z))},TargetCamera.prototype.zoomIn=function(){console.log("zoom in");var offset,distance,next,self=this;return offset=(new THREE.Vector3).subVectors(self.position,self.target),distance=offset.length(),offset.setLength(distance/self.ZOOM_FACTOR),next=(new THREE.Vector3).addVectors(self.target,offset),self.planner.tweenToPosition(self,new THREE.Vector3(next.x,next.y,next.z),self.target,self.emit.bind(self))},TargetCamera.prototype.zoomOut=function(){console.log("zoom out");var offset,distance,next,self=this;return offset=(new THREE.Vector3).subVectors(self.position,self.target),distance=offset.length(),offset.setLength(distance*self.ZOOM_FACTOR),next=(new THREE.Vector3).addVectors(self.target,offset),self.planner.tweenToPosition(self,new THREE.Vector3(next.x,next.y,next.z),self.target,self.emit.bind(self))},TargetCamera.prototype.zoomToFit=function(bbox){console.log("zoom to fit all or selected items");var direction,distance,next,self=this;return direction=(new THREE.Vector3).subVectors(self.position,self.target),distance=bbox.getRadius()/Math.tan(Math.PI*self.fov/360),direction.setLength(distance),next=(new THREE.Vector3).addVectors(bbox.getCenter(),direction),self.planner.tweenToPosition(self,new THREE.Vector3(next.x,next.y,next.z),bbox.getCenter(),self.emit.bind(self))},TargetCamera.prototype.zoomToWindow=function(){throw new Error("zoom in to window")},TargetCamera}();var FOUR=FOUR||{};FOUR.Viewport3D=function(){function Viewport3D(elementId,scene){THREE.EventDispatcher.call(this),this.MODES={ORBIT:"orbit",SELECTION:"selection",TRACKBALL:"trackball",WALK:"walk"},this.WALK_HEIGHT=7.5,this.backgroundColor=new THREE.Color(0,1),this.camera=null,this.clock=new THREE.Clock,this.controller={},this.domElement=null,this.domElementId=elementId,this.mode=this.MODES.SELECTION,this.renderContinuous=!1,this.renderer=null,this.scene=scene||new THREE.Scene,this.walk={index:0,path:[]}}return Viewport3D.prototype=Object.create(THREE.EventDispatcher.prototype),Viewport3D.prototype.constructor=Viewport3D,Viewport3D.prototype.getViewBoundingBox=function(){var self=this;if(self.scene.selection.count>0)return self.scene.selection.getBoundingBox();var bbox=new FOUR.BoundingBox("scene-bounding-box");return bbox.update(self.scene.model.children),bbox},Viewport3D.prototype.handleResize=function(){var self=this,height=self.domElement.clientHeight,width=self.domElement.clientWidth;self.camera.aspect=width/height,self.camera.updateProjectionMatrix(),self.renderer.setSize(width,height),self.render()},Viewport3D.prototype.init=function(){var self=this;self.domElement=document.getElementById(self.domElementId),self.renderer=new THREE.WebGLRenderer({antialias:!0}),self.renderer.setClearColor(self.backgroundColor),self.renderer.setSize(self.domElement.clientWidth,self.domElement.clientHeight),self.renderer.shadowMap.enabled=!0,self.domElement.appendChild(self.renderer.domElement),self.setCamera(self.scene.DEFAULT_CAMERA_NAME),self.setupKeyboardBindings(),self.setupControllers(),window.addEventListener("resize",function(){self.handleResize()},!0),self.scene.addEventListener("update",self.render.bind(self)),self.render(),self.update()},Viewport3D.prototype.render=function(){var self=this;self.renderer.render(self.scene,self.camera)},Viewport3D.prototype.setCamera=function(name){var self=this;self.camera=self.scene.getCamera(name),self.render()},Viewport3D.prototype.setMode=function(mode){var self=this;self.controller[self.mode].disable(),self.mode=mode,self.mode===self.MODES.SELECTION?(console.log("select mode"),self.controller.selection.enable()):self.mode===self.MODES.ORBIT?(console.log("orbit mode"),self.controller.orbit.enable()):self.mode===self.MODES.TRACKBALL?(console.log("trackball mode"),self.controller.trackball.enable()):self.mode===self.MODES.WALK&&(console.log("walk mode"),self.controller.walk.enable())},Viewport3D.prototype.setupControllers=function(){var self=this;self.controller.selection=new FOUR.SelectionControl({viewport:self}),self.controller.selection.addEventListener("update",self.render.bind(self)),self.controller.trackball=new FOUR.TrackballController(self.camera,self.domElement),self.controller.trackball.rotateSpeed=1,self.controller.trackball.zoomSpeed=1.2,self.controller.trackball.panSpeed=.8,self.controller.trackball.noZoom=!1,self.controller.trackball.noPan=!1,self.controller.trackball.staticMoving=!0,self.controller.trackball.dynamicDampingFactor=.3,self.controller.trackball.keys=[65,83,68],self.controller.trackball.disable(),self.controller.trackball.addEventListener("change",self.render.bind(self)),self.controller.walk=new FOUR.WalkController(self.camera,self.domElement),self.controller.walk.enforceWalkHeight=!0,self.controller.walk.disable(),self.controller.walk.addEventListener("change",self.render.bind(self)),self.controller.orbit=new FOUR.OrbitController(self.camera,self.domElement),self.controller.orbit.dampingFactor=.25,self.controller.orbit.enableDamping=!0,self.controller.orbit.enablePan=!0,self.controller.orbit.enableZoom=!0,self.controller.orbit.target.set(0,0,0),self.controller.orbit.disable(),self.controller.orbit.addEventListener("change",self.render.bind(self)),self.controller.keystate=new FOUR.KeyStateController,self.controller.keystate.addEventListener("keydown",self.controller.selection.onKeyDown.bind(self.controller.selection)),self.controller.keystate.addEventListener("keyup",self.controller.selection.onKeyUp.bind(self.controller.selection)),self.controller.keystate.addEventListener("keydown",self.controller.walk.onKeyDown.bind(self.controller.walk)),self.controller.keystate.addEventListener("keyup",self.controller.walk.onKeyUp.bind(self.controller.walk)),self.setMode(self.mode)},Viewport3D.prototype.setupKeyboardBindings=function(){var self=this;Mousetrap.bind("b",function(){console.log("toggle bounding box visibility"),self.scene.boundingBox.toggleVisibility(),self.render()}),Mousetrap.bind("q",function(){self.setMode(self.MODES.SELECTION)}),Mousetrap.bind("w",function(){self.setMode(self.MODES.TRACKBALL)}),Mousetrap.bind("e",function(){self.setMode(self.MODES.WALK)}),Mousetrap.bind("r",function(){self.setMode(self.MODES.ORBIT)}),Mousetrap.bind("f",function(){var bbox=self.getViewBoundingBox();self.camera.zoomToFit(bbox).then(function(){})}),Mousetrap.bind("5",function(){var bbox=self.getViewBoundingBox();self.camera.setView(self.camera.VIEWS.TOP,bbox)}),Mousetrap.bind("6",function(){var bbox=self.getViewBoundingBox();self.camera.setView(self.camera.VIEWS.FRONT,bbox)}),Mousetrap.bind("7",function(){var bbox=self.getViewBoundingBox();self.camera.setView(self.camera.VIEWS.LEFT,bbox)}),Mousetrap.bind("8",function(){var bbox=self.getViewBoundingBox();self.camera.setView(self.camera.VIEWS.RIGHT,bbox)}),Mousetrap.bind("9",function(){var bbox=self.getViewBoundingBox();self.camera.setView(self.camera.VIEWS.BACK,bbox)}),Mousetrap.bind("0",function(){var bbox=self.getViewBoundingBox();self.camera.setView(self.camera.VIEWS.PERSPECTIVE,bbox)}),Mousetrap.bind("g",function(){self.generateWalkPath()}),Mousetrap.bind(",",function(){self.walkToPreviousPoint()}),Mousetrap.bind(".",function(){self.walkToNextPoint()}),Mousetrap.bind("/",function(){console.log("switch object focus"),self.moveToNextWaypointFeature()}),Mousetrap.bind("t",function(){console.log("toggle camera target visibility"),self.camera.target.visible?self.camera.hideTarget():self.camera.showTarget()}),Mousetrap.bind("y",function(){console.log("toggle camera frustrum visibility"),self.camera.frustrum.visible?self.camera.hideFrustrum():self.camera.showFrustrum()}),Mousetrap.bind("=",function(){self.camera.zoomIn()}),Mousetrap.bind("-",function(){self.camera.zoomOut()})},Viewport3D.prototype.update=function(){var self=this;requestAnimationFrame(self.update.bind(self)),TWEEN.update();var delta=self.clock.getDelta();self.controller[self.mode].update(delta)},Viewport3D}();var FOUR=FOUR||{};FOUR.MultiController=function(){function MultiController(camera,domElement){THREE.EventDispatcher.call(this);var self=this;self.EVENTS={CHANGE:{},END:{},START:{}},self.KEY={A:65,S:83,D:68,I:73,J:74,K:75,L:76,CANCEL:27,MOVE_FORWARD:73,MOVE_LEFT:74,MOVE_BACK:75,MOVE_RIGHT:76,MOVE_UP:85,MOVE_DOWN:79},self.camera=camera,self.domElement=void 0!==domElement?domElement:document,self.enabled=!0,self.screen={left:0,top:0,width:0,height:0},self.panSpeed=.3,self.rotateSpeed=1,self.translateSpeed=1,self.zoomSpeed=1.2,self.noZoom=!1,self.noPan=!1,self.noRotate=!1,self.noTranslate=!1,self.staticMoving=!1,self.dynamicDampingFactor=.2,self.minDistance=0,self.maxDistance=1/0,self.keys=[65,83,68,73,74,75,76],self.target=new THREE.Vector3,self.target0=self.target.clone(),self.position0=self.camera.position.clone(),self.up0=self.camera.up.clone(),self.changeEvent={type:"change"},self.startEvent={type:"start"},self.endEvent={type:"end"}}var EPS=1e-6,lastPosition=new THREE.Vector3,STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4,TRANSLATE:5},_state=STATE.NONE,_prevState=STATE.NONE,_eye=new THREE.Vector3,_movePrev=new THREE.Vector2,_moveCurr=new THREE.Vector2,_lastAxis=new THREE.Vector3,_lastAngle=0,_zoomStart=new THREE.Vector2,_zoomEnd=new THREE.Vector2,_touchZoomDistanceStart=0,_touchZoomDistanceEnd=0,_panStart=new THREE.Vector2,_panEnd=new THREE.Vector2;return MultiController.prototype=Object.create(THREE.EventDispatcher.prototype),MultiController.prototype.constructor=MultiController,MultiController.prototype.checkDistances=function(){var self=this;self.noZoom&&self.noPan||(_eye.lengthSq()>self.maxDistance*self.maxDistance&&(self.camera.position.addVectors(self.target,_eye.setLength(self.maxDistance)),_zoomStart.copy(_zoomEnd)),_eye.lengthSq()<self.minDistance*self.minDistance&&(self.camera.position.addVectors(self.target,_eye.setLength(self.minDistance)),_zoomStart.copy(_zoomEnd)))},MultiController.prototype.contextmenu=function(event){event.preventDefault()},MultiController.prototype.disable=function(){var self=this;self.enabled=!1,self.domElement.removeEventListener("contextmenu",self.contextmenu),self.domElement.removeEventListener("mousedown",self.mousedown),self.domElement.removeEventListener("mousewheel",self.mousewheel),self.domElement.removeEventListener("DOMMouseScroll",self.mousewheel),self.domElement.removeEventListener("touchstart",self.touchstart),self.domElement.removeEventListener("touchend",self.touchend),self.domElement.removeEventListener("touchmove",self.touchmove),document.removeEventListener("mousemove",self.mousemove),document.removeEventListener("mouseup",self.mouseup),window.removeEventListener("keydown",self.keydown),window.removeEventListener("keyup",self.keyup)},MultiController.prototype.enable=function(){var self=this;self.enabled=!0,self.handleResize(),self.domElement.addEventListener("contextmenu",self.contextmenu),self.domElement.addEventListener("mousedown",self.mousedown.bind(self)),self.domElement.addEventListener("mousewheel",self.mousewheel.bind(self)),self.domElement.addEventListener("DOMMouseScroll",self.mousewheel.bind(self)),
self.domElement.addEventListener("touchstart",self.touchstart.bind(self)),self.domElement.addEventListener("touchend",self.touchend.bind(self)),self.domElement.addEventListener("touchmove",self.touchmove.bind(self)),window.addEventListener("keydown",self.keydown.bind(self)),window.addEventListener("keyup",self.keyup.bind(self))},MultiController.prototype.getMouseOnCircle=function(){var vector=new THREE.Vector2;return function(pageX,pageY){return vector.set((pageX-.5*this.screen.width-this.screen.left)/(.5*this.screen.width),(this.screen.height+2*(this.screen.top-pageY))/this.screen.width),vector}}(),MultiController.prototype.getMouseOnScreen=function(){var vector=new THREE.Vector2;return function(pageX,pageY){return vector.set((pageX-this.screen.left)/this.screen.width,(pageY-this.screen.top)/this.screen.height),vector}}(),MultiController.prototype.handleEvent=function(event){"function"==typeof this[event.type]&&this[event.type](event)},MultiController.prototype.handleResize=function(){var self=this;if(self.domElement===document)self.screen.left=0,self.screen.top=0,self.screen.width=window.innerWidth,self.screen.height=window.innerHeight;else{var box=self.domElement.getBoundingClientRect(),d=self.domElement.ownerDocument.documentElement;self.screen.left=box.left+window.pageXOffset-d.clientLeft,self.screen.top=box.top+window.pageYOffset-d.clientTop,self.screen.width=box.width,self.screen.height=box.height}},MultiController.prototype.keydown=function(event){var self=this;self.enabled!==!1&&(window.removeEventListener("keydown",self.keydown.bind(self)),_prevState=_state,_state===STATE.NONE&&(event.keyCode!==self.keys[STATE.ROTATE]||self.noRotate?event.keyCode!==self.keys[STATE.ZOOM]||self.noZoom?event.keyCode!==self.keys[STATE.PAN]||self.noPan?(event.keyCode>=73||event.keyCode<=76)&&(_state=STATE.TRANSLATE):_state=STATE.PAN:_state=STATE.ZOOM:_state=STATE.ROTATE))},MultiController.prototype.keyup=function(event){var self=this;self.enabled!==!1&&(_state=_prevState,window.addEventListener("keydown",self.keydown.bind(self)))},MultiController.prototype.mousedown=function(event){var self=this;self.enabled!==!1&&(event.preventDefault(),event.stopPropagation(),_state===STATE.NONE&&(_state=event.button),_state!==STATE.ROTATE||self.noRotate?_state!==STATE.ZOOM||self.noZoom?_state!==STATE.PAN||self.noPan||(_panStart.copy(self.getMouseOnScreen(event.pageX,event.pageY)),_panEnd.copy(_panStart)):(_zoomStart.copy(self.getMouseOnScreen(event.pageX,event.pageY)),_zoomEnd.copy(_zoomStart)):(_moveCurr.copy(self.getMouseOnCircle(event.pageX,event.pageY)),_movePrev.copy(_moveCurr)),document.addEventListener("mousemove",self.mousemove.bind(self)),document.addEventListener("mouseup",self.mouseup.bind(self)),self.dispatchEvent(self.startEvent))},MultiController.prototype.mousemove=function(event){var self=this;self.enabled!==!1&&(event.preventDefault(),event.stopPropagation(),_state!==STATE.ROTATE||self.noRotate?_state!==STATE.ZOOM||self.noZoom?_state!==STATE.PAN||self.noPan||_panEnd.copy(self.getMouseOnScreen(event.pageX,event.pageY)):_zoomEnd.copy(self.getMouseOnScreen(event.pageX,event.pageY)):(_movePrev.copy(_moveCurr),_moveCurr.copy(self.getMouseOnCircle(event.pageX,event.pageY))))},MultiController.prototype.mouseup=function(event){var self=this;self.enabled!==!1&&(event.preventDefault(),event.stopPropagation(),_state=STATE.NONE,document.removeEventListener("mousemove",self.mousemove.bind(self)),document.removeEventListener("mouseup",self.mouseup.bind(self)),self.dispatchEvent(self.endEvent))},MultiController.prototype.mousewheel=function(event){var self=this;if(self.enabled!==!1){event.preventDefault(),event.stopPropagation();var delta=0;event.wheelDelta?delta=event.wheelDelta/40:event.detail&&(delta=-event.detail/3),_zoomStart.y+=.01*delta,self.dispatchEvent(self.startEvent),self.dispatchEvent(self.endEvent)}},MultiController.prototype.panCamera=function(){var mouseChange=new THREE.Vector2,cameraUp=new THREE.Vector3,pan=new THREE.Vector3;return function(){var self=this;mouseChange.copy(_panEnd).sub(_panStart),mouseChange.lengthSq()&&(mouseChange.multiplyScalar(_eye.length()*self.panSpeed),pan.copy(_eye).cross(self.camera.up).setLength(mouseChange.x),pan.add(cameraUp.copy(self.camera.up).setLength(mouseChange.y)),self.camera.position.add(pan),self.target.add(pan),self.staticMoving?_panStart.copy(_panEnd):_panStart.add(mouseChange.subVectors(_panEnd,_panStart).multiplyScalar(self.dynamicDampingFactor)))}}(),MultiController.prototype.reset=function(){var self=this;_state=STATE.NONE,_prevState=STATE.NONE,self.target.copy(self.target0),self.camera.position.copy(self.position0),self.camera.up.copy(self.up0),_eye.subVectors(self.camera.position,self.target),self.camera.lookAt(self.target),self.dispatchEvent(self.changeEvent),lastPosition.copy(self.camera.position)},MultiController.prototype.rotateCamera=function(){var angle,axis=new THREE.Vector3,quaternion=new THREE.Quaternion,eyeDirection=new THREE.Vector3,cameraUpDirection=new THREE.Vector3,cameraSidewaysDirection=new THREE.Vector3,moveDirection=new THREE.Vector3;return function(){var self=this;moveDirection.set(_moveCurr.x-_movePrev.x,_moveCurr.y-_movePrev.y,0),angle=moveDirection.length(),angle?(_eye.copy(self.camera.position).sub(self.target),eyeDirection.copy(_eye).normalize(),cameraUpDirection.copy(self.camera.up).normalize(),cameraSidewaysDirection.crossVectors(cameraUpDirection,eyeDirection).normalize(),cameraUpDirection.setLength(_moveCurr.y-_movePrev.y),cameraSidewaysDirection.setLength(_moveCurr.x-_movePrev.x),moveDirection.copy(cameraUpDirection.add(cameraSidewaysDirection)),axis.crossVectors(moveDirection,_eye).normalize(),angle*=self.rotateSpeed,quaternion.setFromAxisAngle(axis,angle),_eye.applyQuaternion(quaternion),self.camera.up.applyQuaternion(quaternion),_lastAxis.copy(axis),_lastAngle=angle):!self.staticMoving&&_lastAngle&&(_lastAngle*=Math.sqrt(1-self.dynamicDampingFactor),_eye.copy(self.camera.position).sub(self.target),quaternion.setFromAxisAngle(_lastAxis,_lastAngle),_eye.applyQuaternion(quaternion),self.camera.up.applyQuaternion(quaternion)),_movePrev.copy(_moveCurr)}}(),MultiController.prototype.touchstart=function(event){var self=this;if(self.enabled!==!1){switch(event.touches.length){case 1:_state=STATE.TOUCH_ROTATE,_moveCurr.copy(self.getMouseOnCircle(event.touches[0].pageX,event.touches[0].pageY)),_movePrev.copy(_moveCurr);break;case 2:_state=STATE.TOUCH_ZOOM_PAN;var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY;_touchZoomDistanceEnd=_touchZoomDistanceStart=Math.sqrt(dx*dx+dy*dy);var x=(event.touches[0].pageX+event.touches[1].pageX)/2,y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panStart.copy(self.getMouseOnScreen(x,y)),_panEnd.copy(_panStart);break;default:_state=STATE.NONE}self.dispatchEvent(self.startEvent)}},MultiController.prototype.touchmove=function(event){var self=this;if(self.enabled!==!1)switch(event.preventDefault(),event.stopPropagation(),event.touches.length){case 1:_movePrev.copy(_moveCurr),_moveCurr.copy(self.getMouseOnCircle(event.touches[0].pageX,event.touches[0].pageY));break;case 2:var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY;_touchZoomDistanceEnd=Math.sqrt(dx*dx+dy*dy);var x=(event.touches[0].pageX+event.touches[1].pageX)/2,y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panEnd.copy(self.getMouseOnScreen(x,y));break;default:_state=STATE.NONE}},MultiController.prototype.touchend=function(event){var self=this;if(self.enabled!==!1){switch(event.touches.length){case 1:_movePrev.copy(_moveCurr),_moveCurr.copy(self.getMouseOnCircle(event.touches[0].pageX,event.touches[0].pageY));break;case 2:_touchZoomDistanceStart=_touchZoomDistanceEnd=0;var x=(event.touches[0].pageX+event.touches[1].pageX)/2,y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panEnd.copy(self.getMouseOnScreen(x,y)),_panStart.copy(_panEnd)}_state=STATE.NONE,self.dispatchEvent(self.endEvent)}},MultiController.prototype.translateCamera=function(){},MultiController.prototype.update=function(){var self=this;_eye.subVectors(self.camera.position,self.target),self.noRotate||self.rotateCamera(),self.noZoom||self.zoomCamera(),self.noPan||self.panCamera(),self.noTranslate||self.translateCamera(),self.camera.position.addVectors(self.target,_eye),self.checkDistances(),self.camera.lookAt(self.target),lastPosition.distanceToSquared(self.camera.position)>EPS&&(self.dispatchEvent(self.changeEvent),lastPosition.copy(self.camera.position))},MultiController.prototype.zoomCamera=function(){var factor,self=this;_state===STATE.TOUCH_ZOOM_PAN?(factor=_touchZoomDistanceStart/_touchZoomDistanceEnd,_touchZoomDistanceStart=_touchZoomDistanceEnd,_eye.multiplyScalar(factor)):(factor=1+(_zoomEnd.y-_zoomStart.y)*self.zoomSpeed,1!==factor&&factor>0&&(_eye.multiplyScalar(factor),self.staticMoving?_zoomStart.copy(_zoomEnd):_zoomStart.y+=(_zoomEnd.y-_zoomStart.y)*this.dynamicDampingFactor))},MultiController}();var FOUR=FOUR||{};FOUR.OrbitController=function(){function OrbitConstraint(camera){this.camera=camera,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-(1/0),this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25;var theta,phi,scope=this,EPS=1e-6,phiDelta=0,thetaDelta=0,scale=1,panOffset=new THREE.Vector3,zoomChanged=!1,offset=new THREE.Vector3,quat=(new THREE.Quaternion).setFromUnitVectors(camera.up,new THREE.Vector3(0,1,0)),quatInverse=quat.clone().inverse(),lastPosition=new THREE.Vector3,lastQuaternion=new THREE.Quaternion;this.dollyIn=function(dollyScale){scope.camera instanceof THREE.PerspectiveCamera?scale/=dollyScale:scope.camera instanceof THREE.OrthographicCamera?(scope.camera.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.camera.zoom*dollyScale)),scope.camera.updateProjectionMatrix(),zoomChanged=!0):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")},this.dollyOut=function(dollyScale){scope.camera instanceof THREE.PerspectiveCamera?scale*=dollyScale:scope.camera instanceof THREE.OrthographicCamera?(scope.camera.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.camera.zoom/dollyScale)),scope.camera.updateProjectionMatrix(),zoomChanged=!0):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")},this.getPolarAngle=function(){return phi},this.getAzimuthalAngle=function(){return theta},this.rotateLeft=function(angle){thetaDelta-=angle},this.rotateUp=function(angle){phiDelta-=angle},this.panLeft=function(){var v=new THREE.Vector3;return function(distance){var te=this.camera.matrix.elements;v.set(te[0],te[1],te[2]),v.multiplyScalar(-distance),panOffset.add(v)}}(),this.panUp=function(){var v=new THREE.Vector3;return function(distance){var te=this.camera.matrix.elements;v.set(te[4],te[5],te[6]),v.multiplyScalar(distance),panOffset.add(v)}}(),this.pan=function(deltaX,deltaY,screenWidth,screenHeight){if(scope.camera instanceof THREE.PerspectiveCamera){var position=scope.camera.position,offset=position.clone().sub(scope.target),targetDistance=offset.length();targetDistance*=Math.tan(scope.camera.fov/2*Math.PI/180),scope.panLeft(2*deltaX*targetDistance/screenHeight),scope.panUp(2*deltaY*targetDistance/screenHeight)}else scope.camera instanceof THREE.OrthographicCamera?(scope.panLeft(deltaX*(scope.camera.right-scope.camera.left)/screenWidth),scope.panUp(deltaY*(scope.camera.top-scope.camera.bottom)/screenHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.sync=function(){this.target=new THREE.Vector3(0,0,-1),this.target.applyMatrix4(camera.matrixWorld)},this.update=function(){var position=this.camera.position;offset.copy(position).sub(this.target),offset.applyQuaternion(quat),theta=Math.atan2(offset.x,offset.z),phi=Math.atan2(Math.sqrt(offset.x*offset.x+offset.z*offset.z),offset.y),theta+=thetaDelta,phi+=phiDelta,theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,theta)),phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,phi)),phi=Math.max(EPS,Math.min(Math.PI-EPS,phi));var radius=offset.length()*scale;return radius=Math.max(this.minDistance,Math.min(this.maxDistance,radius)),this.target.add(panOffset),offset.x=radius*Math.sin(phi)*Math.sin(theta),offset.y=radius*Math.cos(phi),offset.z=radius*Math.sin(phi)*Math.cos(theta),offset.applyQuaternion(quatInverse),position.copy(this.target).add(offset),this.camera.lookAt(this.target),this.enableDamping===!0?(thetaDelta*=1-this.dampingFactor,phiDelta*=1-this.dampingFactor):(thetaDelta=0,phiDelta=0),scale=1,panOffset.set(0,0,0),zoomChanged||lastPosition.distanceToSquared(this.camera.position)>EPS||8*(1-lastQuaternion.dot(this.camera.quaternion))>EPS?(lastPosition.copy(this.camera.position),lastQuaternion.copy(this.camera.quaternion),zoomChanged=!1,!0):!1}}function OrbitController(camera,domElement){THREE.EventDispatcher.call(this);var constraint=new OrbitConstraint(camera);this.domElement=void 0!==domElement?domElement:document,Object.defineProperty(this,"constraint",{get:function(){return constraint}}),this.enabled=!0,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var scope=this,STATE=(new THREE.Vector2,new THREE.Vector2,new THREE.Vector2,new THREE.Vector2,new THREE.Vector2,new THREE.Vector2,new THREE.Vector2,new THREE.Vector2,new THREE.Vector2,{NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5});STATE.NONE;this.target0=this.target.clone(),this.position0=this.camera.position.clone(),this.zoom0=this.camera.zoom,scope.changeEvent={type:"change"},scope.startEvent={type:"start"},scope.endEvent={type:"end"},this.listen(),this.update()}return OrbitController.prototype=Object.create(THREE.EventDispatcher.prototype),OrbitController.prototype.constructor=OrbitController,OrbitController.prototype.disable=function(){var self=this;self.enabled=!1,self.dispose()},OrbitController.prototype.dispose=function(){var self=this;self.domElement.removeEventListener("contextmenu",self.contextmenu,!1),self.domElement.removeEventListener("mousedown",self.onMouseDown,!1),self.domElement.removeEventListener("mousewheel",self.onMouseWheel,!1),self.domElement.removeEventListener("DOMMouseScroll",self.onMouseWheel,!1),self.domElement.removeEventListener("mousemove",self.onMouseMove,!1),self.domElement.removeEventListener("mouseup",self.onMouseUp,!1)},OrbitController.prototype.enable=function(){var self=this;self.constraint.sync(),self.enabled=!0,self.listen()},OrbitController.prototype.getAzimuthalAngle=function(){return this.constraint.getAzimuthalAngle()},OrbitController.prototype.getPolarAngle=function(){return this.constraint.getPolarAngle()},OrbitController.prototype.listen=function(){var self=this;self.domElement.addEventListener("contextmenu",self.contextmenu,!1),self.domElement.addEventListener("mousedown",self.onMouseDown,!1),self.domElement.addEventListener("mousewheel",self.onMouseWheel,!1),self.domElement.addEventListener("DOMMouseScroll",self.onMouseWheel,!1),self.domElement.addEventListener("mouseup",self.onMouseUp,!1)},OrbitController.prototype.onMouseWheel=function(event){var self=this;if(self.enabled!==!1&&self.enableZoom!==!1&&self.state===self.STATE.NONE){event.preventDefault(),event.stopPropagation();var delta=0;void 0!==event.wheelDelta?delta=event.wheelDelta:void 0!==event.detail&&(delta=-event.detail),delta>0?self.constraint.dollyOut(self.getZoomScale()):0>delta&&self.constraint.dollyIn(self.getZoomScale()),self.update(),self.dispatchEvent(self.startEvent),self.dispatchEvent(self.endEvent)}},OrbitController.prototype.pan=function(deltaX,deltaY){var self=this,element=self.domElement===document?self.domElement.body:self.domElement;self.constraint.pan(deltaX,deltaY,element.clientWidth,element.clientHeight)},OrbitController.prototype.reset=function(){var self=this;self.state=self.STATE.NONE,self.target.copy(self.target0),self.camera.position.copy(self.position0),self.camera.zoom=self.zoom0,self.camera.updateProjectionMatrix(),self.dispatchEvent(self.changeEvent),self.update()},OrbitController.prototype.update=function(){var self=this;self.autoRotate&&self.state===self.STATE.NONE&&self.constraint.rotateLeft(self.getAutoRotationAngle()),self.constraint.update()===!0&&self.dispatchEvent(self.changeEvent)},Object.defineProperties(OrbitController.prototype,{camera:{get:function(){return this.constraint.camera}},target:{get:function(){return this.constraint.target},set:function(value){console.warn("THREE.OrbitControls: target is now immutable. Use target.set() instead."),this.constraint.target.copy(value)}},minDistance:{get:function(){return this.constraint.minDistance},set:function(value){this.constraint.minDistance=value}},maxDistance:{get:function(){return this.constraint.maxDistance},set:function(value){this.constraint.maxDistance=value}},minZoom:{get:function(){return this.constraint.minZoom},set:function(value){this.constraint.minZoom=value}},maxZoom:{get:function(){return this.constraint.maxZoom},set:function(value){this.constraint.maxZoom=value}},minPolarAngle:{get:function(){return this.constraint.minPolarAngle},set:function(value){this.constraint.minPolarAngle=value}},maxPolarAngle:{get:function(){return this.constraint.maxPolarAngle},set:function(value){this.constraint.maxPolarAngle=value}},minAzimuthAngle:{get:function(){return this.constraint.minAzimuthAngle},set:function(value){this.constraint.minAzimuthAngle=value}},maxAzimuthAngle:{get:function(){return this.constraint.maxAzimuthAngle},set:function(value){this.constraint.maxAzimuthAngle=value}},enableDamping:{get:function(){return this.constraint.enableDamping},set:function(value){this.constraint.enableDamping=value}},dampingFactor:{get:function(){return this.constraint.dampingFactor},set:function(value){this.constraint.dampingFactor=value}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(value){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!value}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(value){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!value}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(value){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!value}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(value){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!value}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.constraint.enableDamping},set:function(value){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.constraint.enableDamping=!value}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.constraint.dampingFactor},set:function(value){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.constraint.dampingFactor=value}}}),OrbitController}();var FOUR=FOUR||{};FOUR.TrackballController=function(object,domElement){function contextmenu(event){event.preventDefault()}function keydown(event){_this.enabled!==!1&&(window.removeEventListener("keydown",keydown),_prevState=_state,_state===STATE.NONE&&(event.keyCode!==_this.keys[STATE.ROTATE]||_this.noRotate?event.keyCode!==_this.keys[STATE.ZOOM]||_this.noZoom?event.keyCode!==_this.keys[STATE.PAN]||_this.noPan?(event.keyCode>=73||event.keyCode<=76)&&(_state=STATE.TRANSLATE):_state=STATE.PAN:_state=STATE.ZOOM:_state=STATE.ROTATE))}function keyup(event){_this.enabled!==!1&&(_state=_prevState,window.addEventListener("keydown",keydown,!1))}function mousedown(event){_this.enabled!==!1&&(event.preventDefault(),event.stopPropagation(),_state===STATE.NONE&&(_state=event.button),_state!==STATE.ROTATE||_this.noRotate?_state!==STATE.ZOOM||_this.noZoom?_state!==STATE.PAN||_this.noPan||(_panStart.copy(getMouseOnScreen(event.pageX,event.pageY)),_panEnd.copy(_panStart)):(_zoomStart.copy(getMouseOnScreen(event.pageX,event.pageY)),_zoomEnd.copy(_zoomStart)):(_moveCurr.copy(getMouseOnCircle(event.pageX,event.pageY)),_movePrev.copy(_moveCurr)),document.addEventListener("mousemove",mousemove,!1),document.addEventListener("mouseup",mouseup,!1),_this.dispatchEvent(startEvent))}function mousemove(event){_this.enabled!==!1&&(event.preventDefault(),event.stopPropagation(),_state!==STATE.ROTATE||_this.noRotate?_state!==STATE.ZOOM||_this.noZoom?_state!==STATE.PAN||_this.noPan||_panEnd.copy(getMouseOnScreen(event.pageX,event.pageY)):_zoomEnd.copy(getMouseOnScreen(event.pageX,event.pageY)):(_movePrev.copy(_moveCurr),_moveCurr.copy(getMouseOnCircle(event.pageX,event.pageY))))}function mouseup(event){_this.enabled!==!1&&(event.preventDefault(),event.stopPropagation(),_state=STATE.NONE,document.removeEventListener("mousemove",mousemove),document.removeEventListener("mouseup",mouseup),_this.dispatchEvent(endEvent))}function mousewheel(event){if(_this.enabled!==!1){event.preventDefault(),event.stopPropagation();var delta=0;event.wheelDelta?delta=event.wheelDelta/40:event.detail&&(delta=-event.detail/3),_zoomStart.y+=.01*delta,_this.dispatchEvent(startEvent),_this.dispatchEvent(endEvent)}}function touchstart(event){if(_this.enabled!==!1){switch(event.touches.length){case 1:_state=STATE.TOUCH_ROTATE,_moveCurr.copy(getMouseOnCircle(event.touches[0].pageX,event.touches[0].pageY)),_movePrev.copy(_moveCurr);break;case 2:_state=STATE.TOUCH_ZOOM_PAN;var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY;_touchZoomDistanceEnd=_touchZoomDistanceStart=Math.sqrt(dx*dx+dy*dy);var x=(event.touches[0].pageX+event.touches[1].pageX)/2,y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panStart.copy(getMouseOnScreen(x,y)),_panEnd.copy(_panStart);break;default:_state=STATE.NONE}_this.dispatchEvent(startEvent)}}function touchmove(event){if(_this.enabled!==!1)switch(event.preventDefault(),event.stopPropagation(),event.touches.length){case 1:_movePrev.copy(_moveCurr),_moveCurr.copy(getMouseOnCircle(event.touches[0].pageX,event.touches[0].pageY));break;case 2:var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY;_touchZoomDistanceEnd=Math.sqrt(dx*dx+dy*dy);var x=(event.touches[0].pageX+event.touches[1].pageX)/2,y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panEnd.copy(getMouseOnScreen(x,y));break;default:_state=STATE.NONE}}function touchend(event){if(_this.enabled!==!1){switch(event.touches.length){case 1:_movePrev.copy(_moveCurr),_moveCurr.copy(getMouseOnCircle(event.touches[0].pageX,event.touches[0].pageY));break;case 2:_touchZoomDistanceStart=_touchZoomDistanceEnd=0;var x=(event.touches[0].pageX+event.touches[1].pageX)/2,y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panEnd.copy(getMouseOnScreen(x,y)),_panStart.copy(_panEnd)}_state=STATE.NONE,_this.dispatchEvent(endEvent)}}var _this=this,STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4,TRANSLATE:5};this.object=object,this.domElement=void 0!==domElement?domElement:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.panSpeed=.3,this.rotateSpeed=1,this.translateSpeed=1,this.zoomSpeed=1.2,this.noZoom=!1,this.noPan=!1,this.noRotate=!1,this.noTranslate=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68,73,74,75,76],this.target=new THREE.Vector3;var EPS=1e-6,lastPosition=new THREE.Vector3,_state=STATE.NONE,_prevState=STATE.NONE,_eye=new THREE.Vector3,_movePrev=new THREE.Vector2,_moveCurr=new THREE.Vector2,_lastAxis=new THREE.Vector3,_lastAngle=0,_zoomStart=new THREE.Vector2,_zoomEnd=new THREE.Vector2,_touchZoomDistanceStart=0,_touchZoomDistanceEnd=0,_panStart=new THREE.Vector2,_panEnd=new THREE.Vector2;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var changeEvent={type:"change"},startEvent={type:"start"},endEvent={type:"end"},getMouseOnScreen=function(){var vector=new THREE.Vector2;return function(pageX,pageY){return vector.set((pageX-_this.screen.left)/_this.screen.width,(pageY-_this.screen.top)/_this.screen.height),vector}}(),getMouseOnCircle=function(){var vector=new THREE.Vector2;return function(pageX,pageY){return vector.set((pageX-.5*_this.screen.width-_this.screen.left)/(.5*_this.screen.width),(_this.screen.height+2*(_this.screen.top-pageY))/_this.screen.width),vector}}();this.checkDistances=function(){_this.noZoom&&_this.noPan||(_eye.lengthSq()>_this.maxDistance*_this.maxDistance&&(_this.object.position.addVectors(_this.target,_eye.setLength(_this.maxDistance)),_zoomStart.copy(_zoomEnd)),_eye.lengthSq()<_this.minDistance*_this.minDistance&&(_this.object.position.addVectors(_this.target,_eye.setLength(_this.minDistance)),_zoomStart.copy(_zoomEnd)))},this.disable=function(){this.enabled=!1,this.domElement.removeEventListener("contextmenu",contextmenu,!1),this.domElement.removeEventListener("mousedown",mousedown,!1),this.domElement.removeEventListener("mousewheel",mousewheel,!1),this.domElement.removeEventListener("DOMMouseScroll",mousewheel,!1),this.domElement.removeEventListener("touchstart",touchstart,!1),this.domElement.removeEventListener("touchend",touchend,!1),this.domElement.removeEventListener("touchmove",touchmove,!1),document.removeEventListener("mousemove",mousemove,!1),document.removeEventListener("mouseup",mouseup,!1),window.removeEventListener("keydown",keydown,!1),window.removeEventListener("keyup",keyup,!1)},this.enable=function(){this.enabled=!0,this.domElement.addEventListener("contextmenu",contextmenu,!1),this.domElement.addEventListener("mousedown",mousedown,!1),this.domElement.addEventListener("mousewheel",mousewheel,!1),this.domElement.addEventListener("DOMMouseScroll",mousewheel,!1),this.domElement.addEventListener("touchstart",touchstart,!1),this.domElement.addEventListener("touchend",touchend,!1),this.domElement.addEventListener("touchmove",touchmove,!1),window.addEventListener("keydown",keydown,!1),window.addEventListener("keyup",keyup,!1)},this.handleEvent=function(event){"function"==typeof this[event.type]&&this[event.type](event)},this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var box=this.domElement.getBoundingClientRect(),d=this.domElement.ownerDocument.documentElement;this.screen.left=box.left+window.pageXOffset-d.clientLeft,this.screen.top=box.top+window.pageYOffset-d.clientTop,this.screen.width=box.width,this.screen.height=box.height}},this.panCamera=function(){var mouseChange=new THREE.Vector2,objectUp=new THREE.Vector3,pan=new THREE.Vector3;return function(){mouseChange.copy(_panEnd).sub(_panStart),mouseChange.lengthSq()&&(mouseChange.multiplyScalar(_eye.length()*_this.panSpeed),pan.copy(_eye).cross(_this.object.up).setLength(mouseChange.x),pan.add(objectUp.copy(_this.object.up).setLength(mouseChange.y)),_this.object.position.add(pan),_this.target.add(pan),_this.staticMoving?_panStart.copy(_panEnd):_panStart.add(mouseChange.subVectors(_panEnd,_panStart).multiplyScalar(_this.dynamicDampingFactor)))}}(),this.reset=function(){_state=STATE.NONE,_prevState=STATE.NONE,_this.target.copy(_this.target0),_this.object.position.copy(_this.position0),_this.object.up.copy(_this.up0),_eye.subVectors(_this.object.position,_this.target),_this.object.lookAt(_this.target),_this.dispatchEvent(changeEvent),lastPosition.copy(_this.object.position)},this.rotateCamera=function(){var angle,axis=new THREE.Vector3,quaternion=new THREE.Quaternion,eyeDirection=new THREE.Vector3,objectUpDirection=new THREE.Vector3,objectSidewaysDirection=new THREE.Vector3,moveDirection=new THREE.Vector3;return function(){moveDirection.set(_moveCurr.x-_movePrev.x,_moveCurr.y-_movePrev.y,0),angle=moveDirection.length(),angle?(_eye.copy(_this.object.position).sub(_this.target),eyeDirection.copy(_eye).normalize(),objectUpDirection.copy(_this.object.up).normalize(),objectSidewaysDirection.crossVectors(objectUpDirection,eyeDirection).normalize(),objectUpDirection.setLength(_moveCurr.y-_movePrev.y),objectSidewaysDirection.setLength(_moveCurr.x-_movePrev.x),moveDirection.copy(objectUpDirection.add(objectSidewaysDirection)),axis.crossVectors(moveDirection,_eye).normalize(),angle*=_this.rotateSpeed,quaternion.setFromAxisAngle(axis,angle),_eye.applyQuaternion(quaternion),_this.object.up.applyQuaternion(quaternion),_lastAxis.copy(axis),_lastAngle=angle):!_this.staticMoving&&_lastAngle&&(_lastAngle*=Math.sqrt(1-_this.dynamicDampingFactor),_eye.copy(_this.object.position).sub(_this.target),quaternion.setFromAxisAngle(_lastAxis,_lastAngle),_eye.applyQuaternion(quaternion),_this.object.up.applyQuaternion(quaternion)),_movePrev.copy(_moveCurr)}}(),this.translateCamera=function(){},this.zoomCamera=function(){var factor;_state===STATE.TOUCH_ZOOM_PAN?(factor=_touchZoomDistanceStart/_touchZoomDistanceEnd,_touchZoomDistanceStart=_touchZoomDistanceEnd,_eye.multiplyScalar(factor)):(factor=1+(_zoomEnd.y-_zoomStart.y)*_this.zoomSpeed,1!==factor&&factor>0&&(_eye.multiplyScalar(factor),_this.staticMoving?_zoomStart.copy(_zoomEnd):_zoomStart.y+=(_zoomEnd.y-_zoomStart.y)*this.dynamicDampingFactor))},this.update=function(){_eye.subVectors(_this.object.position,_this.target),_this.noRotate||_this.rotateCamera(),_this.noZoom||_this.zoomCamera(),_this.noPan||_this.panCamera(),_this.noTranslate||_this.translateCamera(),_this.object.position.addVectors(_this.target,_eye),_this.checkDistances(),_this.object.lookAt(_this.target),lastPosition.distanceToSquared(_this.object.position)>EPS&&(_this.dispatchEvent(changeEvent),lastPosition.copy(_this.object.position))}},FOUR.TrackballController.prototype=Object.create(THREE.EventDispatcher.prototype),FOUR.TrackballController.prototype.constructor=FOUR.TrackballController;var FOUR=FOUR||{};FOUR.WalkController=function(){function WalkController(camera,domElement){THREE.EventDispatcher.call(this);var self=this;self.KEY={CANCEL:27,MOVE_FORWARD:73,MOVE_LEFT:74,MOVE_BACK:75,MOVE_RIGHT:76,MOVE_UP:85,MOVE_DOWN:79},self.camera=camera,self.domElement=domElement,self.enabled=!1,self.lookChange=!1,self.lookSpeed=.85,self.modifiers={ALT:!1,CTRL:!1,SHIFT:!1},self.mouse={direction:new THREE.Vector2,end:{x:0,y:0},start:{x:0,y:0}},self.move={forward:!1,backward:!1,left:!1,right:!1,up:!1,down:!1},self.movementSpeed=100,self.enforceWalkHeight=!1,self.walkHeight=null,self.viewHalfX=self.domElement.offsetWidth/2,self.viewHalfY=self.domElement.offsetHeight/2,self.domElement.setAttribute("tabindex",-1)}return WalkController.prototype=Object.create(THREE.EventDispatcher.prototype),WalkController.prototype.constructor=WalkController,WalkController.prototype.WALK_HEIGHT=2,WalkController.prototype.disable=function(){var self=this;self.enabled=!1,self.domElement.removeEventListener("mousedown",self.onMouseDown)},WalkController.prototype.enable=function(){var self=this;self.domElement.addEventListener("mousedown",self.onMouseDown.bind(self)),
self.enforceWalkHeight?self.setWalkHeight().then(function(){self.enabled=!0}):self.enabled=!0},WalkController.prototype.getWalkHeight=function(position){return 0},WalkController.prototype.onKeyDown=function(event){var self=this;if(self.enabled)switch(event.keyCode){case self.KEY.MOVE_FORWARD:self.move.forward=!0;break;case self.KEY.MOVE_BACK:self.move.backward=!0;break;case self.KEY.MOVE_LEFT:self.move.left=!0;break;case self.KEY.MOVE_RIGHT:self.move.right=!0;break;case self.KEY.MOVE_UP:self.move.up=!0;break;case self.KEY.MOVE_DOWN:self.move.down=!0}},WalkController.prototype.onKeyUp=function(event){var self=this;switch(event.keyCode){case self.KEY.MOVE_FORWARD:self.move.forward=!1;break;case self.KEY.MOVE_BACK:self.move.backward=!1;break;case self.KEY.MOVE_LEFT:self.move.left=!1;break;case self.KEY.MOVE_RIGHT:self.move.right=!1;break;case self.KEY.MOVE_UP:self.move.up=!1;break;case self.KEY.MOVE_DOWN:self.move.down=!1;break;case self.KEY.CANCEL:Object.keys(self.move).forEach(function(key){self.move[key]=!1}),self.lookChange=!1}},WalkController.prototype.onMouseDown=function(event){var self=this;self.mouse.start=new THREE.Vector2(event.pageX-self.domElement.offsetLeft-self.viewHalfX,event.pageY-self.domElement.offsetTop-self.viewHalfY),self.domElement.addEventListener("mousemove",self.onMouseMove.bind(self),!1),self.domElement.addEventListener("mouseup",self.onMouseUp.bind(self),!1),self.lookChange=!0},WalkController.prototype.onMouseMove=function(event){var self=this;self.mouse.end=new THREE.Vector2(event.pageX-self.domElement.offsetLeft-self.viewHalfX,event.pageY-self.domElement.offsetTop-self.viewHalfY),self.mouse.direction=new THREE.Vector2(self.mouse.end.x/self.domElement.clientWidth*2,self.mouse.end.y/self.domElement.clientHeight*2)},WalkController.prototype.onMouseUp=function(event){var self=this;self.domElement.removeEventListener("mousemove",self.onMouseMove),self.domElement.removeEventListener("mouseup",self.onMouseUp),self.lookChange=!1},WalkController.prototype.onResize=function(){console.log("resize")},WalkController.prototype.setWalkHeight=function(){var self=this;return self.camera.setPositionAndTarget(self.camera.position.x,self.camera.position.y,self.WALK_HEIGHT,self.camera.target.x,self.camera.target.y,self.WALK_HEIGHT)},WalkController.prototype.update=function(delta){var self=this;if(self.enabled){var distance=delta*self.movementSpeed,change=!1;self.move.forward&&(self.camera.translateZ(-distance),change=!0),self.move.backward&&(self.camera.translateZ(distance),change=!0),self.move.right&&(self.camera.translateX(distance),change=!0),self.move.left&&(self.camera.translateX(-distance),change=!0),self.move.up&&(self.camera.translateY(-distance),change=!0),self.move.down&&(self.camera.translateY(distance),change=!0),self.lookChange&&(self.camera.rotateOnAxis(new THREE.Vector3(0,1,0),2*Math.PI/360*-self.mouse.direction.x*self.lookSpeed),change=!0),change&&self.dispatchEvent({type:"change"})}},WalkController}(),THREE.FirstPersonControls=function(object,domElement){function bind(scope,fn){return function(){fn.apply(scope,arguments)}}this.object=object,this.target=new THREE.Vector3(0,0,0),this.domElement=void 0!==domElement?domElement:document,this.movementSpeed=1,this.lookSpeed=.005,this.noFly=!1,this.lookVertical=!0,this.autoForward=!1,this.activeLook=!0,this.heightSpeed=!1,this.heightCoef=1,this.heightMin=0,this.constrainVertical=!1,this.verticalMin=0,this.verticalMax=Math.PI,this.autoSpeedFactor=0,this.mouseX=0,this.mouseY=0,this.lat=0,this.lon=0,this.phi=0,this.theta=0,this.moveForward=!1,this.moveBackward=!1,this.moveLeft=!1,this.moveRight=!1,this.freeze=!1,this.mouseDragOn=!1,this.domElement===document?(this.viewHalfX=window.innerWidth/2,this.viewHalfY=window.innerHeight/2):(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2,this.domElement.setAttribute("tabindex",-1)),this.onMouseDown=function(event){if(this.domElement!==document&&this.domElement.focus(),event.preventDefault(),event.stopPropagation(),this.activeLook)switch(event.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0}this.mouseDragOn=!0},this.onMouseUp=function(event){if(event.preventDefault(),event.stopPropagation(),this.activeLook)switch(event.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1}this.mouseDragOn=!1},this.onMouseMove=function(event){this.domElement===document?(this.mouseX=event.pageX-this.viewHalfX,this.mouseY=event.pageY-this.viewHalfY):(this.mouseX=event.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=event.pageY-this.domElement.offsetTop-this.viewHalfY)},this.onKeyDown=function(event){switch(event.keyCode){case 38:case 87:this.moveForward=!0;break;case 37:case 65:this.moveLeft=!0;break;case 40:case 83:this.moveBackward=!0;break;case 39:case 68:this.moveRight=!0;break;case 82:this.moveUp=!0;break;case 70:this.moveDown=!0;break;case 81:this.freeze=!this.freeze}},this.onKeyUp=function(event){switch(event.keyCode){case 38:case 87:this.moveForward=!1;break;case 37:case 65:this.moveLeft=!1;break;case 40:case 83:this.moveBackward=!1;break;case 39:case 68:this.moveRight=!1;break;case 82:this.moveUp=!1;break;case 70:this.moveDown=!1}},this.update=function(delta){var actualMoveSpeed=0;if(!this.freeze){if(this.heightSpeed){var y=THREE.Math.clamp(this.object.position.y,this.heightMin,this.heightMax),heightDelta=y-this.heightMin;this.autoSpeedFactor=delta*(heightDelta*this.heightCoef)}else this.autoSpeedFactor=0;actualMoveSpeed=delta*this.movementSpeed,(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(actualMoveSpeed+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(actualMoveSpeed),this.moveLeft&&this.object.translateX(-actualMoveSpeed),this.moveRight&&this.object.translateX(actualMoveSpeed),this.moveUp&&this.object.translateY(actualMoveSpeed),this.moveDown&&this.object.translateY(-actualMoveSpeed);var actualLookSpeed=delta*this.lookSpeed;this.activeLook||(actualLookSpeed=0),this.lon+=this.mouseX*actualLookSpeed,this.lookVertical&&(this.lat-=this.mouseY*actualLookSpeed),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*Math.PI/180,this.theta=this.lon*Math.PI/180;var targetPosition=this.target,position=this.object.position;targetPosition.x=position.x+100*Math.sin(this.phi)*Math.cos(this.theta),targetPosition.y=position.y+100*Math.cos(this.phi),targetPosition.z=position.z+100*Math.sin(this.phi)*Math.sin(this.theta)}var verticalLookRatio=1;this.constrainVertical&&(verticalLookRatio=Math.PI/(this.verticalMax-this.verticalMin)),this.lon+=this.mouseX*actualLookSpeed,this.lookVertical&&(this.lat-=this.mouseY*actualLookSpeed*verticalLookRatio),this.lat=Math.max(-85,Math.min(85,this.lat)),this.phi=(90-this.lat)*Math.PI/180,this.theta=this.lon*Math.PI/180,this.constrainVertical&&(this.phi=THREE.Math.mapLinear(this.phi,0,Math.PI,this.verticalMin,this.verticalMax));var targetPosition=this.target,position=this.object.position;targetPosition.x=position.x+100*Math.sin(this.phi)*Math.cos(this.theta),targetPosition.y=position.y+100*Math.cos(this.phi),targetPosition.z=position.z+100*Math.sin(this.phi)*Math.sin(this.theta),this.object.lookAt(targetPosition)},this.domElement.addEventListener("contextmenu",function(event){event.preventDefault()},!1),this.domElement.addEventListener("mousemove",bind(this,this.onMouseMove),!1),this.domElement.addEventListener("mousedown",bind(this,this.onMouseDown),!1),this.domElement.addEventListener("mouseup",bind(this,this.onMouseUp),!1),this.domElement.addEventListener("keydown",bind(this,this.onKeyDown),!1),this.domElement.addEventListener("keyup",bind(this,this.onKeyUp),!1)},function(){function OrbitConstraint(object){this.object=object,this.target=new THREE.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-(1/0),this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.25;var theta,phi,scope=this,EPS=1e-6,phiDelta=0,thetaDelta=0,scale=1,panOffset=new THREE.Vector3,zoomChanged=!1;this.getPolarAngle=function(){return phi},this.getAzimuthalAngle=function(){return theta},this.rotateLeft=function(angle){thetaDelta-=angle},this.rotateUp=function(angle){phiDelta-=angle},this.panLeft=function(){var v=new THREE.Vector3;return function(distance){var te=this.object.matrix.elements;v.set(te[0],te[1],te[2]),v.multiplyScalar(-distance),panOffset.add(v)}}(),this.panUp=function(){var v=new THREE.Vector3;return function(distance){var te=this.object.matrix.elements;v.set(te[4],te[5],te[6]),v.multiplyScalar(distance),panOffset.add(v)}}(),this.pan=function(deltaX,deltaY,screenWidth,screenHeight){if(scope.object instanceof THREE.PerspectiveCamera){var position=scope.object.position,offset=position.clone().sub(scope.target),targetDistance=offset.length();targetDistance*=Math.tan(scope.object.fov/2*Math.PI/180),scope.panLeft(2*deltaX*targetDistance/screenHeight),scope.panUp(2*deltaY*targetDistance/screenHeight)}else scope.object instanceof THREE.OrthographicCamera?(scope.panLeft(deltaX*(scope.object.right-scope.object.left)/screenWidth),scope.panUp(deltaY*(scope.object.top-scope.object.bottom)/screenHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(dollyScale){scope.object instanceof THREE.PerspectiveCamera?scale/=dollyScale:scope.object instanceof THREE.OrthographicCamera?(scope.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom*dollyScale)),scope.object.updateProjectionMatrix(),zoomChanged=!0):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")},this.dollyOut=function(dollyScale){scope.object instanceof THREE.PerspectiveCamera?scale*=dollyScale:scope.object instanceof THREE.OrthographicCamera?(scope.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/dollyScale)),scope.object.updateProjectionMatrix(),zoomChanged=!0):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")},this.update=function(){var offset=new THREE.Vector3,quat=(new THREE.Quaternion).setFromUnitVectors(object.up,new THREE.Vector3(0,1,0)),quatInverse=quat.clone().inverse(),lastPosition=new THREE.Vector3,lastQuaternion=new THREE.Quaternion;return function(){var position=this.object.position;offset.copy(position).sub(this.target),offset.applyQuaternion(quat),theta=Math.atan2(offset.x,offset.z),phi=Math.atan2(Math.sqrt(offset.x*offset.x+offset.z*offset.z),offset.y),theta+=thetaDelta,phi+=phiDelta,theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,theta)),phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,phi)),phi=Math.max(EPS,Math.min(Math.PI-EPS,phi));var radius=offset.length()*scale;return radius=Math.max(this.minDistance,Math.min(this.maxDistance,radius)),this.target.add(panOffset),offset.x=radius*Math.sin(phi)*Math.sin(theta),offset.y=radius*Math.cos(phi),offset.z=radius*Math.sin(phi)*Math.cos(theta),offset.applyQuaternion(quatInverse),position.copy(this.target).add(offset),this.object.lookAt(this.target),this.enableDamping===!0?(thetaDelta*=1-this.dampingFactor,phiDelta*=1-this.dampingFactor):(thetaDelta=0,phiDelta=0),scale=1,panOffset.set(0,0,0),zoomChanged||lastPosition.distanceToSquared(this.object.position)>EPS||8*(1-lastQuaternion.dot(this.object.quaternion))>EPS?(lastPosition.copy(this.object.position),lastQuaternion.copy(this.object.quaternion),zoomChanged=!1,!0):!1}}()}THREE.OrbitControls=function(object,domElement){function pan(deltaX,deltaY){var element=scope.domElement===document?scope.domElement.body:scope.domElement;constraint.pan(deltaX,deltaY,element.clientWidth,element.clientHeight)}function getAutoRotationAngle(){return 2*Math.PI/60/60*scope.autoRotateSpeed}function getZoomScale(){return Math.pow(.95,scope.zoomSpeed)}function onMouseDown(event){if(scope.enabled!==!1){if(event.preventDefault(),event.button===scope.mouseButtons.ORBIT){if(scope.enableRotate===!1)return;state=STATE.ROTATE,rotateStart.set(event.clientX,event.clientY)}else if(event.button===scope.mouseButtons.ZOOM){if(scope.enableZoom===!1)return;state=STATE.DOLLY,dollyStart.set(event.clientX,event.clientY)}else if(event.button===scope.mouseButtons.PAN){if(scope.enablePan===!1)return;state=STATE.PAN,panStart.set(event.clientX,event.clientY)}state!==STATE.NONE&&(document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("mouseup",onMouseUp,!1),scope.dispatchEvent(startEvent))}}function onMouseMove(event){if(scope.enabled!==!1){event.preventDefault();var element=scope.domElement===document?scope.domElement.body:scope.domElement;if(state===STATE.ROTATE){if(scope.enableRotate===!1)return;rotateEnd.set(event.clientX,event.clientY),rotateDelta.subVectors(rotateEnd,rotateStart),constraint.rotateLeft(2*Math.PI*rotateDelta.x/element.clientWidth*scope.rotateSpeed),constraint.rotateUp(2*Math.PI*rotateDelta.y/element.clientHeight*scope.rotateSpeed),rotateStart.copy(rotateEnd)}else if(state===STATE.DOLLY){if(scope.enableZoom===!1)return;dollyEnd.set(event.clientX,event.clientY),dollyDelta.subVectors(dollyEnd,dollyStart),dollyDelta.y>0?constraint.dollyIn(getZoomScale()):dollyDelta.y<0&&constraint.dollyOut(getZoomScale()),dollyStart.copy(dollyEnd)}else if(state===STATE.PAN){if(scope.enablePan===!1)return;panEnd.set(event.clientX,event.clientY),panDelta.subVectors(panEnd,panStart),pan(panDelta.x,panDelta.y),panStart.copy(panEnd)}state!==STATE.NONE&&scope.update()}}function onMouseUp(){scope.enabled!==!1&&(document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1),scope.dispatchEvent(endEvent),state=STATE.NONE)}function onMouseWheel(event){if(scope.enabled!==!1&&scope.enableZoom!==!1&&state===STATE.NONE){event.preventDefault(),event.stopPropagation();var delta=0;void 0!==event.wheelDelta?delta=event.wheelDelta:void 0!==event.detail&&(delta=-event.detail),delta>0?constraint.dollyOut(getZoomScale()):0>delta&&constraint.dollyIn(getZoomScale()),scope.update(),scope.dispatchEvent(startEvent),scope.dispatchEvent(endEvent)}}function onKeyDown(event){if(scope.enabled!==!1&&scope.enableKeys!==!1&&scope.enablePan!==!1)switch(event.keyCode){case scope.keys.UP:pan(0,scope.keyPanSpeed),scope.update();break;case scope.keys.BOTTOM:pan(0,-scope.keyPanSpeed),scope.update();break;case scope.keys.LEFT:pan(scope.keyPanSpeed,0),scope.update();break;case scope.keys.RIGHT:pan(-scope.keyPanSpeed,0),scope.update()}}function touchstart(event){if(scope.enabled!==!1){switch(event.touches.length){case 1:if(scope.enableRotate===!1)return;state=STATE.TOUCH_ROTATE,rotateStart.set(event.touches[0].pageX,event.touches[0].pageY);break;case 2:if(scope.enableZoom===!1)return;state=STATE.TOUCH_DOLLY;var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY,distance=Math.sqrt(dx*dx+dy*dy);dollyStart.set(0,distance);break;case 3:if(scope.enablePan===!1)return;state=STATE.TOUCH_PAN,panStart.set(event.touches[0].pageX,event.touches[0].pageY);break;default:state=STATE.NONE}state!==STATE.NONE&&scope.dispatchEvent(startEvent)}}function touchmove(event){if(scope.enabled!==!1){event.preventDefault(),event.stopPropagation();var element=scope.domElement===document?scope.domElement.body:scope.domElement;switch(event.touches.length){case 1:if(scope.enableRotate===!1)return;if(state!==STATE.TOUCH_ROTATE)return;rotateEnd.set(event.touches[0].pageX,event.touches[0].pageY),rotateDelta.subVectors(rotateEnd,rotateStart),constraint.rotateLeft(2*Math.PI*rotateDelta.x/element.clientWidth*scope.rotateSpeed),constraint.rotateUp(2*Math.PI*rotateDelta.y/element.clientHeight*scope.rotateSpeed),rotateStart.copy(rotateEnd),scope.update();break;case 2:if(scope.enableZoom===!1)return;if(state!==STATE.TOUCH_DOLLY)return;var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY,distance=Math.sqrt(dx*dx+dy*dy);dollyEnd.set(0,distance),dollyDelta.subVectors(dollyEnd,dollyStart),dollyDelta.y>0?constraint.dollyOut(getZoomScale()):dollyDelta.y<0&&constraint.dollyIn(getZoomScale()),dollyStart.copy(dollyEnd),scope.update();break;case 3:if(scope.enablePan===!1)return;if(state!==STATE.TOUCH_PAN)return;panEnd.set(event.touches[0].pageX,event.touches[0].pageY),panDelta.subVectors(panEnd,panStart),pan(panDelta.x,panDelta.y),panStart.copy(panEnd),scope.update();break;default:state=STATE.NONE}}}function touchend(){scope.enabled!==!1&&(scope.dispatchEvent(endEvent),state=STATE.NONE)}function contextmenu(event){event.preventDefault()}var constraint=new OrbitConstraint(object);this.domElement=void 0!==domElement?domElement:document,Object.defineProperty(this,"constraint",{get:function(){return constraint}}),this.getPolarAngle=function(){return constraint.getPolarAngle()},this.getAzimuthalAngle=function(){return constraint.getAzimuthalAngle()},this.enabled=!0,this.center=this.target,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!0,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var scope=this,rotateStart=new THREE.Vector2,rotateEnd=new THREE.Vector2,rotateDelta=new THREE.Vector2,panStart=new THREE.Vector2,panEnd=new THREE.Vector2,panDelta=new THREE.Vector2,dollyStart=new THREE.Vector2,dollyEnd=new THREE.Vector2,dollyDelta=new THREE.Vector2,STATE={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},state=STATE.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom;var changeEvent={type:"change"},startEvent={type:"start"},endEvent={type:"end"};this.update=function(){this.autoRotate&&state===STATE.NONE&&constraint.rotateLeft(getAutoRotationAngle()),constraint.update()===!0&&this.dispatchEvent(changeEvent)},this.reset=function(){state=STATE.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this.dispatchEvent(changeEvent),this.update()},this.dispose=function(){this.domElement.removeEventListener("contextmenu",contextmenu,!1),this.domElement.removeEventListener("mousedown",onMouseDown,!1),this.domElement.removeEventListener("mousewheel",onMouseWheel,!1),this.domElement.removeEventListener("DOMMouseScroll",onMouseWheel,!1),this.domElement.removeEventListener("touchstart",touchstart,!1),this.domElement.removeEventListener("touchend",touchend,!1),this.domElement.removeEventListener("touchmove",touchmove,!1),document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1),window.removeEventListener("keydown",onKeyDown,!1)},this.domElement.addEventListener("contextmenu",contextmenu,!1),this.domElement.addEventListener("mousedown",onMouseDown,!1),this.domElement.addEventListener("mousewheel",onMouseWheel,!1),this.domElement.addEventListener("DOMMouseScroll",onMouseWheel,!1),this.domElement.addEventListener("touchstart",touchstart,!1),this.domElement.addEventListener("touchend",touchend,!1),this.domElement.addEventListener("touchmove",touchmove,!1),window.addEventListener("keydown",onKeyDown,!1),this.update()},THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.OrbitControls.prototype.constructor=THREE.OrbitControls,Object.defineProperties(THREE.OrbitControls.prototype,{object:{get:function(){return this.constraint.object}},target:{get:function(){return this.constraint.target},set:function(value){console.warn("THREE.OrbitControls: target is now immutable. Use target.set() instead."),this.constraint.target.copy(value)}},minDistance:{get:function(){return this.constraint.minDistance},set:function(value){this.constraint.minDistance=value}},maxDistance:{get:function(){return this.constraint.maxDistance},set:function(value){this.constraint.maxDistance=value}},minZoom:{get:function(){return this.constraint.minZoom},set:function(value){this.constraint.minZoom=value}},maxZoom:{get:function(){return this.constraint.maxZoom},set:function(value){this.constraint.maxZoom=value}},minPolarAngle:{get:function(){return this.constraint.minPolarAngle},set:function(value){this.constraint.minPolarAngle=value}},maxPolarAngle:{get:function(){return this.constraint.maxPolarAngle},set:function(value){this.constraint.maxPolarAngle=value}},minAzimuthAngle:{get:function(){return this.constraint.minAzimuthAngle},set:function(value){this.constraint.minAzimuthAngle=value}},maxAzimuthAngle:{get:function(){return this.constraint.maxAzimuthAngle},set:function(value){this.constraint.maxAzimuthAngle=value}},enableDamping:{get:function(){return this.constraint.enableDamping},set:function(value){this.constraint.enableDamping=value}},dampingFactor:{get:function(){return this.constraint.dampingFactor},set:function(value){this.constraint.dampingFactor=value}},noZoom:{get:function(){return console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),!this.enableZoom},set:function(value){console.warn("THREE.OrbitControls: .noZoom has been deprecated. Use .enableZoom instead."),this.enableZoom=!value}},noRotate:{get:function(){return console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),!this.enableRotate},set:function(value){console.warn("THREE.OrbitControls: .noRotate has been deprecated. Use .enableRotate instead."),this.enableRotate=!value}},noPan:{get:function(){return console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),!this.enablePan},set:function(value){console.warn("THREE.OrbitControls: .noPan has been deprecated. Use .enablePan instead."),this.enablePan=!value}},noKeys:{get:function(){return console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),!this.enableKeys},set:function(value){console.warn("THREE.OrbitControls: .noKeys has been deprecated. Use .enableKeys instead."),this.enableKeys=!value}},staticMoving:{get:function(){return console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),!this.constraint.enableDamping},set:function(value){console.warn("THREE.OrbitControls: .staticMoving has been deprecated. Use .enableDamping instead."),this.constraint.enableDamping=!value}},dynamicDampingFactor:{get:function(){return console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.constraint.dampingFactor},set:function(value){console.warn("THREE.OrbitControls: .dynamicDampingFactor has been renamed. Use .dampingFactor instead."),this.constraint.dampingFactor=value}}})}(),THREE.TrackballControls=function(object,domElement){function keydown(event){_this.enabled!==!1&&(window.removeEventListener("keydown",keydown),_prevState=_state,_state===STATE.NONE&&(event.keyCode!==_this.keys[STATE.ROTATE]||_this.noRotate?event.keyCode!==_this.keys[STATE.ZOOM]||_this.noZoom?event.keyCode!==_this.keys[STATE.PAN]||_this.noPan||(_state=STATE.PAN):_state=STATE.ZOOM:_state=STATE.ROTATE))}function keyup(event){_this.enabled!==!1&&(_state=_prevState,window.addEventListener("keydown",keydown,!1))}function mousedown(event){_this.enabled!==!1&&(event.preventDefault(),event.stopPropagation(),_state===STATE.NONE&&(_state=event.button),_state!==STATE.ROTATE||_this.noRotate?_state!==STATE.ZOOM||_this.noZoom?_state!==STATE.PAN||_this.noPan||(_panStart.copy(getMouseOnScreen(event.pageX,event.pageY)),_panEnd.copy(_panStart)):(_zoomStart.copy(getMouseOnScreen(event.pageX,event.pageY)),_zoomEnd.copy(_zoomStart)):(_moveCurr.copy(getMouseOnCircle(event.pageX,event.pageY)),_movePrev.copy(_moveCurr)),document.addEventListener("mousemove",mousemove,!1),document.addEventListener("mouseup",mouseup,!1),_this.dispatchEvent(startEvent))}function mousemove(event){_this.enabled!==!1&&(event.preventDefault(),event.stopPropagation(),_state!==STATE.ROTATE||_this.noRotate?_state!==STATE.ZOOM||_this.noZoom?_state!==STATE.PAN||_this.noPan||_panEnd.copy(getMouseOnScreen(event.pageX,event.pageY)):_zoomEnd.copy(getMouseOnScreen(event.pageX,event.pageY)):(_movePrev.copy(_moveCurr),_moveCurr.copy(getMouseOnCircle(event.pageX,event.pageY))))}function mouseup(event){_this.enabled!==!1&&(event.preventDefault(),event.stopPropagation(),_state=STATE.NONE,document.removeEventListener("mousemove",mousemove),document.removeEventListener("mouseup",mouseup),_this.dispatchEvent(endEvent))}function mousewheel(event){if(_this.enabled!==!1){event.preventDefault(),event.stopPropagation();var delta=0;event.wheelDelta?delta=event.wheelDelta/40:event.detail&&(delta=-event.detail/3),_zoomStart.y+=.01*delta,_this.dispatchEvent(startEvent),_this.dispatchEvent(endEvent)}}function touchstart(event){if(_this.enabled!==!1){switch(event.touches.length){case 1:_state=STATE.TOUCH_ROTATE,_moveCurr.copy(getMouseOnCircle(event.touches[0].pageX,event.touches[0].pageY)),_movePrev.copy(_moveCurr);break;case 2:_state=STATE.TOUCH_ZOOM_PAN;var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY;_touchZoomDistanceEnd=_touchZoomDistanceStart=Math.sqrt(dx*dx+dy*dy);var x=(event.touches[0].pageX+event.touches[1].pageX)/2,y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panStart.copy(getMouseOnScreen(x,y)),_panEnd.copy(_panStart);break;default:_state=STATE.NONE}_this.dispatchEvent(startEvent)}}function touchmove(event){if(_this.enabled!==!1)switch(event.preventDefault(),event.stopPropagation(),event.touches.length){case 1:_movePrev.copy(_moveCurr),_moveCurr.copy(getMouseOnCircle(event.touches[0].pageX,event.touches[0].pageY));break;case 2:var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY;_touchZoomDistanceEnd=Math.sqrt(dx*dx+dy*dy);var x=(event.touches[0].pageX+event.touches[1].pageX)/2,y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panEnd.copy(getMouseOnScreen(x,y));break;default:_state=STATE.NONE}}function touchend(event){if(_this.enabled!==!1){switch(event.touches.length){case 1:_movePrev.copy(_moveCurr),_moveCurr.copy(getMouseOnCircle(event.touches[0].pageX,event.touches[0].pageY));break;case 2:_touchZoomDistanceStart=_touchZoomDistanceEnd=0;var x=(event.touches[0].pageX+event.touches[1].pageX)/2,y=(event.touches[0].pageY+event.touches[1].pageY)/2;_panEnd.copy(getMouseOnScreen(x,y)),_panStart.copy(_panEnd)}_state=STATE.NONE,_this.dispatchEvent(endEvent)}}function contextmenu(event){event.preventDefault()}var _this=this,STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=object,this.domElement=void 0!==domElement?domElement:document,this.enabled=!0,this.screen={left:0,top:0,width:0,height:0},this.rotateSpeed=1,this.zoomSpeed=1.2,this.panSpeed=.3,this.noRotate=!1,this.noZoom=!1,this.noPan=!1,this.staticMoving=!1,this.dynamicDampingFactor=.2,this.minDistance=0,this.maxDistance=1/0,this.keys=[65,83,68],this.target=new THREE.Vector3;var EPS=1e-6,lastPosition=new THREE.Vector3,_state=STATE.NONE,_prevState=STATE.NONE,_eye=new THREE.Vector3,_movePrev=new THREE.Vector2,_moveCurr=new THREE.Vector2,_lastAxis=new THREE.Vector3,_lastAngle=0,_zoomStart=new THREE.Vector2,_zoomEnd=new THREE.Vector2,_touchZoomDistanceStart=0,_touchZoomDistanceEnd=0,_panStart=new THREE.Vector2,_panEnd=new THREE.Vector2;this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone();var changeEvent={type:"change"},startEvent={type:"start"},endEvent={type:"end"};this.handleResize=function(){if(this.domElement===document)this.screen.left=0,this.screen.top=0,this.screen.width=window.innerWidth,this.screen.height=window.innerHeight;else{var box=this.domElement.getBoundingClientRect(),d=this.domElement.ownerDocument.documentElement;this.screen.left=box.left+window.pageXOffset-d.clientLeft,this.screen.top=box.top+window.pageYOffset-d.clientTop,this.screen.width=box.width,this.screen.height=box.height}},this.handleEvent=function(event){"function"==typeof this[event.type]&&this[event.type](event)};var getMouseOnScreen=function(){var vector=new THREE.Vector2;return function(pageX,pageY){return vector.set((pageX-_this.screen.left)/_this.screen.width,(pageY-_this.screen.top)/_this.screen.height),vector}}(),getMouseOnCircle=function(){var vector=new THREE.Vector2;return function(pageX,pageY){return vector.set((pageX-.5*_this.screen.width-_this.screen.left)/(.5*_this.screen.width),(_this.screen.height+2*(_this.screen.top-pageY))/_this.screen.width),vector}}();this.rotateCamera=function(){var angle,axis=new THREE.Vector3,quaternion=new THREE.Quaternion,eyeDirection=new THREE.Vector3,objectUpDirection=new THREE.Vector3,objectSidewaysDirection=new THREE.Vector3,moveDirection=new THREE.Vector3;return function(){moveDirection.set(_moveCurr.x-_movePrev.x,_moveCurr.y-_movePrev.y,0),angle=moveDirection.length(),angle?(_eye.copy(_this.object.position).sub(_this.target),eyeDirection.copy(_eye).normalize(),objectUpDirection.copy(_this.object.up).normalize(),objectSidewaysDirection.crossVectors(objectUpDirection,eyeDirection).normalize(),objectUpDirection.setLength(_moveCurr.y-_movePrev.y),objectSidewaysDirection.setLength(_moveCurr.x-_movePrev.x),moveDirection.copy(objectUpDirection.add(objectSidewaysDirection)),axis.crossVectors(moveDirection,_eye).normalize(),angle*=_this.rotateSpeed,quaternion.setFromAxisAngle(axis,angle),_eye.applyQuaternion(quaternion),_this.object.up.applyQuaternion(quaternion),_lastAxis.copy(axis),_lastAngle=angle):!_this.staticMoving&&_lastAngle&&(_lastAngle*=Math.sqrt(1-_this.dynamicDampingFactor),_eye.copy(_this.object.position).sub(_this.target),quaternion.setFromAxisAngle(_lastAxis,_lastAngle),_eye.applyQuaternion(quaternion),_this.object.up.applyQuaternion(quaternion)),_movePrev.copy(_moveCurr)}}(),this.zoomCamera=function(){var factor;_state===STATE.TOUCH_ZOOM_PAN?(factor=_touchZoomDistanceStart/_touchZoomDistanceEnd,_touchZoomDistanceStart=_touchZoomDistanceEnd,_eye.multiplyScalar(factor)):(factor=1+(_zoomEnd.y-_zoomStart.y)*_this.zoomSpeed,1!==factor&&factor>0&&(_eye.multiplyScalar(factor),_this.staticMoving?_zoomStart.copy(_zoomEnd):_zoomStart.y+=(_zoomEnd.y-_zoomStart.y)*this.dynamicDampingFactor))},this.panCamera=function(){var mouseChange=new THREE.Vector2,objectUp=new THREE.Vector3,pan=new THREE.Vector3;return function(){mouseChange.copy(_panEnd).sub(_panStart),mouseChange.lengthSq()&&(mouseChange.multiplyScalar(_eye.length()*_this.panSpeed),pan.copy(_eye).cross(_this.object.up).setLength(mouseChange.x),pan.add(objectUp.copy(_this.object.up).setLength(mouseChange.y)),_this.object.position.add(pan),_this.target.add(pan),_this.staticMoving?_panStart.copy(_panEnd):_panStart.add(mouseChange.subVectors(_panEnd,_panStart).multiplyScalar(_this.dynamicDampingFactor)))}}(),this.checkDistances=function(){_this.noZoom&&_this.noPan||(_eye.lengthSq()>_this.maxDistance*_this.maxDistance&&(_this.object.position.addVectors(_this.target,_eye.setLength(_this.maxDistance)),_zoomStart.copy(_zoomEnd)),_eye.lengthSq()<_this.minDistance*_this.minDistance&&(_this.object.position.addVectors(_this.target,_eye.setLength(_this.minDistance)),_zoomStart.copy(_zoomEnd)))},this.update=function(){_eye.subVectors(_this.object.position,_this.target),_this.noRotate||_this.rotateCamera(),_this.noZoom||_this.zoomCamera(),_this.noPan||_this.panCamera(),_this.object.position.addVectors(_this.target,_eye),_this.checkDistances(),_this.object.lookAt(_this.target),lastPosition.distanceToSquared(_this.object.position)>EPS&&(_this.dispatchEvent(changeEvent),lastPosition.copy(_this.object.position))},this.reset=function(){_state=STATE.NONE,_prevState=STATE.NONE,_this.target.copy(_this.target0),_this.object.position.copy(_this.position0),_this.object.up.copy(_this.up0),_eye.subVectors(_this.object.position,_this.target),_this.object.lookAt(_this.target),_this.dispatchEvent(changeEvent),
lastPosition.copy(_this.object.position)},this.dispose=function(){this.domElement.removeEventListener("contextmenu",contextmenu,!1),this.domElement.removeEventListener("mousedown",mousedown,!1),this.domElement.removeEventListener("mousewheel",mousewheel,!1),this.domElement.removeEventListener("DOMMouseScroll",mousewheel,!1),this.domElement.removeEventListener("touchstart",touchstart,!1),this.domElement.removeEventListener("touchend",touchend,!1),this.domElement.removeEventListener("touchmove",touchmove,!1),document.removeEventListener("mousemove",mousemove,!1),document.removeEventListener("mouseup",mouseup,!1),window.removeEventListener("keydown",keydown,!1),window.removeEventListener("keyup",keyup,!1)},this.domElement.addEventListener("contextmenu",contextmenu,!1),this.domElement.addEventListener("mousedown",mousedown,!1),this.domElement.addEventListener("mousewheel",mousewheel,!1),this.domElement.addEventListener("DOMMouseScroll",mousewheel,!1),this.domElement.addEventListener("touchstart",touchstart,!1),this.domElement.addEventListener("touchend",touchend,!1),this.domElement.addEventListener("touchmove",touchmove,!1),window.addEventListener("keydown",keydown,!1),window.addEventListener("keyup",keyup,!1),this.handleResize(),this.update()},THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.TrackballControls.prototype.constructor=THREE.TrackballControls;var TravellingSalesman=function(){function Tour(){this.distance=0,this.fitness=0,this.tour=[];for(var i=0;i<Itinerary.length;i++)this.tour.push(null)}function Population(populationSize,initialise){this.tours=[];var i;for(i=0;populationSize>i;i++)this.tours.push(null);if(initialise)for(i=0;populationSize>i;i++){var newTour=new Tour;newTour.generateIndividual(),this.tours[i]=newTour}}function TravellingSalesman(populationSize){this.elitism=!0,this.mutationRate=.015,this.population=null,this.populationSize=populationSize,this.tournamentSize=5}var Itinerary=[];return Tour.prototype.containsPoint=function(p){var result=!1;return this.tour.forEach(function(point){point&&point.x===p.x&&point.y===p.y&&(result=!0)}),result},Tour.prototype.distanceBetween=function(p1,p2){var dx=Math.abs(p2.x-p1.x),dy=Math.abs(p2.y-p1.y);return Math.sqrt(dx*dx+dy*dy)},Tour.prototype.generateIndividual=function(){for(var i=0;i<Itinerary.length;i++)this.setPoint(i,Itinerary[i]);this.shuffle()},Tour.prototype.getPoint=function(i){return this.tour[i]},Tour.prototype.getFitness=function(){return 0===this.fitness&&(this.fitness=1/this.getDistance()),this.fitness},Tour.prototype.getDistance=function(){if(0===this.distance){var i,p1,p2,totalDistance=0;for(i=0;i<this.tour.length;i++)p1=this.getPoint(i),p2=i+1<this.tour.length?this.tour[i+1]:this.tour[0],totalDistance+=this.distanceBetween(p1,p2);this.distance=totalDistance}return this.distance},Tour.prototype.init=function(){for(var i=0;i<Itinerary.length;i++)this.tour.push(null)},Tour.prototype.setPoint=function(i,point){this.tour[i]=point,this.fitness=0,this.distance=0},Tour.prototype.checkForDuplicates=function(){var i;for(i=0;i<this.tour.length;i++){var p=this.tour[i];if(this.tour.lastIndexOf(p)!==i)throw new Error("Tour contains a duplicate element")}},Tour.prototype.shuffle=function(){for(var temporaryValue,randomIndex,currentIndex=this.tour.length;0!==currentIndex;)randomIndex=Math.floor(Math.random()*currentIndex),currentIndex-=1,temporaryValue=this.tour[currentIndex],this.tour[currentIndex]=this.tour[randomIndex],this.tour[randomIndex]=temporaryValue},Tour.prototype.tourSize=function(){return this.tour.length},Population.prototype.getFittest=function(){var i,fittest=this.tours[0];for(i=1;i<this.tours.length;i++)fittest.getFitness()<=this.tours[i].getFitness()&&(fittest=this.tours[i]);return fittest},Population.prototype.getPopulationSize=function(){return this.tours.length},Population.prototype.getTour=function(i){return this.tours[i]},Population.prototype.saveTour=function(i,tour){this.tours[i]=tour},TravellingSalesman.prototype.addPoint=function(obj){Itinerary.push(obj)},TravellingSalesman.prototype.crossover=function(parent1,parent2){var i,ii,child=new Tour,startPos=Math.floor(Math.random()*parent1.tourSize()),endPos=Math.floor(Math.random()*parent1.tourSize());for(i=0;i<child.tourSize();i++)endPos>startPos&&i>startPos&&endPos>i?child.setPoint(i,parent1.getPoint(i)):startPos>endPos&&(startPos>i&&i>endPos||child.setPoint(i,parent1.getPoint(i)));for(i=0;i<parent2.tourSize();i++)if(!child.containsPoint(parent2.getPoint(i)))for(ii=0;ii<child.tourSize();ii++)if(null===child.getPoint(ii)){child.setPoint(ii,parent2.getPoint(i));break}return child.checkForDuplicates(),child},TravellingSalesman.prototype.evolve=function(generations){this.population=this.evolvePopulation(this.population);for(var i=0;generations>i;i++)this.population=this.evolvePopulation(this.population)},TravellingSalesman.prototype.evolvePopulation=function(pop){var i,newPopulation=new Population(pop.getPopulationSize(),!1),elitismOffset=0;for(this.elitism&&(newPopulation.saveTour(0,pop.getFittest()),elitismOffset=1),i=elitismOffset;i<newPopulation.getPopulationSize();i++){var parent1=this.tournamentSelection(pop),parent2=this.tournamentSelection(pop),childTour=this.crossover(parent1,parent2);newPopulation.saveTour(i,childTour)}for(i=elitismOffset;i<newPopulation.getPopulationSize();i++)this.mutate(newPopulation.getTour(i));return newPopulation},TravellingSalesman.prototype.getPopulation=function(){return this.population},TravellingSalesman.prototype.getSolution=function(){return this.population.getFittest().tour},TravellingSalesman.prototype.init=function(){this.population=new Population(this.populationSize,!0)},TravellingSalesman.prototype.mutate=function(tour){for(var tourPos1=0;tourPos1<tour.tourSize();tourPos1++)if(Math.random()<this.mutationRate){var tourPos2=Math.floor(tour.tourSize()*Math.random()),point1=tour.getPoint(tourPos1),point2=tour.getPoint(tourPos2);tour.setPoint(tourPos2,point1),tour.setPoint(tourPos1,point2)}},TravellingSalesman.prototype.setPoints=function(points){var tourManager=Itinerary;points.forEach(function(point){tourManager.push(point)})},TravellingSalesman.prototype.tournamentSelection=function(pop){for(var tournament=new Population(this.tournamentSize,!1),i=0;i<this.tournamentSize;i++){var randomId=Math.floor(Math.random()*pop.getPopulationSize());tournament.saveTour(i,pop.getTour(randomId))}return tournament.getFittest()},TravellingSalesman}();
//# sourceMappingURL=four.min.js.map